<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Suivi communication — Admin</title>
<style>
:root{--bg1:#061024;--bg2:#071733;--text:#eaf0ff;--muted:rgba(234,240,255,.68);--line:rgba(255,255,255,.10);--good:#2bd576;--warn:#ffb020;--bad:#ff5a6b;--info:#58a6ff;--r:18px;--shadow:0 18px 45px rgba(0,0,0,.45)}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
background:radial-gradient(1200px 700px at 10% 0%, rgba(88,166,255,.22), transparent 60%),
radial-gradient(1000px 800px at 90% 10%, rgba(43,213,118,.14), transparent 55%),
linear-gradient(180deg,var(--bg1),var(--bg2))}
header{position:sticky;top:0;z-index:30;backdrop-filter:blur(12px);background:rgba(6,16,36,.78);border-bottom:1px solid var(--line)}
.wrap{max-width:1180px;margin:0 auto;padding:14px 14px 10px}
h1{margin:0;font-size:16px;font-weight:950}
.sub{margin-top:4px;color:var(--muted);font-size:12.5px;line-height:1.35}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
input,select,textarea{background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--text);padding:9px 10px;border-radius:14px;outline:none;font-size:13px}
textarea{min-height:80px;resize:vertical}
.btn{border:1px solid var(--line);background:rgba(255,255,255,.08);color:var(--text);padding:9px 10px;border-radius:14px;cursor:pointer;font-weight:950;font-size:13px}
.btn.primary{border-color:rgba(125,211,252,.35);background:rgba(125,211,252,.12)}
.btn.danger{border-color:rgba(255,90,107,.35);background:rgba(255,90,107,.12)}
.pill{display:inline-flex;align-items:center;gap:7px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.15);color:var(--muted);font-weight:900;font-size:12px}
.dot{width:8px;height:8px;border-radius:50%}
.dot.good{background:var(--good)}.dot.warn{background:var(--warn)}.dot.bad{background:var(--bad)}.dot.info{background:var(--info)}
main{max-width:1180px;margin:0 auto;padding:14px}
.card{border:1px solid var(--line);border-radius:var(--r);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.05));box-shadow:var(--shadow);overflow:hidden;margin-bottom:14px}
.card h2{margin:0;padding:14px 14px 0;font-size:12.5px;letter-spacing:.35px;text-transform:uppercase;color:var(--muted);font-weight:950}
.card .content{padding:12px 14px 14px}
.hint{color:var(--muted);font-size:12px;line-height:1.35}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.tab{border:1px solid var(--line);background:rgba(255,255,255,.06);padding:8px 10px;border-radius:999px;cursor:pointer;font-weight:950;color:var(--muted)}
.tab.active{color:var(--text);background:rgba(255,255,255,.10)}
.multi{min-height:110px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap">
      <div>
        <h1>Admin — Suivi communication</h1>
        <div class="sub"><b>Étape 1 :</b> Responsables (par domaines) · <b>Étape 2 :</b> Actions · <b>Étape 3 :</b> Publier</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="btnBack">← Retour</button>
        <span class="pill"><span class="dot info"></span><span id="src">source: local</span></span>
      </div>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="resp">1) Responsables</div>
      <div class="tab" data-tab="actions">2) Actions</div>
      <div class="tab" data-tab="publish">3) Publier</div>
    </div>
  </div>
</header>

<main>
  <section class="card" id="panelResp">
    <h2>1) Responsables par domaines</h2>
    <div class="content">
      <div class="hint">Définis “qui pilote quoi” (par <b>outil</b> et/ou <b>thème</b>), puis clique <b>Appliquer</b> pour pré-remplir les actions non attribuées.</div>
      <div class="row">
        <input id="newName" placeholder="Nom du responsable" style="min-width:240px">
        <input id="newEmail" placeholder="Email (optionnel)" style="min-width:260px">
        <button class="btn primary" id="btnAddResp">Ajouter</button>
      </div>
      <div id="respList" style="margin-top:10px"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnApplyAuto">Appliquer domaines → responsables des actions (si vide)</button>
      </div>
      <div class="hint" style="margin-top:10px">Règle : outil d’abord, sinon thème.</div>
    </div>
  </section>

  <section class="card" id="panelActions" style="display:none">
    <h2>2) Actions (édition simple)</h2>
    <div class="content">
      <div class="hint">Pour garder ça “lambda”, l’édition détaillée reste sur la version précédente. Ici : attribution et statut.</div>
      <div id="actionsMini"></div>
    </div>
  </section>

  <section class="card" id="panelPublish" style="display:none">
    <h2>3) Publier</h2>
    <div class="content">
      <div class="hint">Pour publier : utilise l’admin “GitHub” (version précédente). Ici on reste en local.</div>
    </div>
  </section>
</main>

<script>
const TOOLS = ["Actions terrain", "FB / Site / Mail", "FB/IG + Site", "Facebook/Instagram", "Groupe com", "Process", "Prospectus", "Réunion plénière", "Réunions de quartier", "Site + Facebook", "Site internet"];
const THEMES = ["Bilans par thème", "Contenus", "Décision", "Interactions", "Interactions / FAQ", "Programme par thème", "Réseaux sociaux", "Réseaux ↔ site", "Site / organisation", "Terrain"];
const el=id=>document.getElementById(id);
let actions=[], responsables=[];

async function loadLocal(){
  actions = await fetch("./data.json?ts="+Date.now()).then(r=>r.json());
  responsables = await fetch("./responsables.json?ts="+Date.now()).then(r=>r.json()).catch(()=>[]);
  if(!Array.isArray(actions)) actions=[];
  if(!Array.isArray(responsables)) responsables=[];
  renderResp();
  renderMini();
}

function renderResp(){
  const html = responsables.map((p, idx)=>{
    const toolOpts = TOOLS.map(t=>`<option value="${t}" ${(p.outils||[]).includes(t)?"selected":""}>${t}</option>`).join("");
    const themeOpts = THEMES.map(t=>`<option value="${t}" ${(p.themes||[]).includes(t)?"selected":""}>${t}</option>`).join("");
    return `
      <div class="card" style="margin:10px 0">
        <h2>${p.nom}</h2>
        <div class="content">
          <div class="row">
            <input value="${p.nom.replace(/"/g,'&quot;')}" data-i="${idx}" data-f="nom" style="min-width:220px">
            <input value="${(p.email||"").replace(/"/g,'&quot;')}" data-i="${idx}" data-f="email" placeholder="email (optionnel)" style="min-width:260px">
            <button class="btn danger" data-del="${idx}">Supprimer</button>
          </div>
          <div class="row">
            <div style="flex:1;min-width:260px">
              <div class="hint" style="margin:0 0 6px 2px">Outils pilotés (multi)</div>
              <select class="multi" multiple data-i="${idx}" data-f="outils" style="width:100%">${toolOpts}</select>
            </div>
            <div style="flex:1;min-width:260px">
              <div class="hint" style="margin:0 0 6px 2px">Thèmes pilotés (optionnel)</div>
              <select class="multi" multiple data-i="${idx}" data-f="themes" style="width:100%">${themeOpts}</select>
            </div>
          </div>
        </div>
      </div>`;
  }).join("") || `<div class="hint">Aucun responsable. Ajoute un nom ci-dessus.</div>`;
  el("respList").innerHTML = html;

  el("respList").querySelectorAll("input[data-i]").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const i=parseInt(inp.dataset.i,10), f=inp.dataset.f;
      responsables[i][f]=inp.value.trim();
    });
  });
  el("respList").querySelectorAll("select[data-i]").forEach(sel=>{
    sel.addEventListener("change", ()=>{
      const i=parseInt(sel.dataset.i,10), f=sel.dataset.f;
      responsables[i][f]=[...sel.selectedOptions].map(o=>o.value);
    });
  });
  el("respList").querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const i=parseInt(btn.dataset.del,10);
      if(!confirm("Supprimer ?")) return;
      responsables.splice(i,1);
      renderResp(); renderMini();
    });
  });
}

function applyAuto(){
  const toolMap=new Map(), themeMap=new Map();
  responsables.forEach(p=>{
    (p.outils||[]).forEach(t=>{ if(!toolMap.has(t)) toolMap.set(t,p.nom); });
    (p.themes||[]).forEach(t=>{ if(!themeMap.has(t)) themeMap.set(t,p.nom); });
  });
  let changed=0;
  actions = actions.map(a=>{
    if((a.responsable||"").trim()) return a;
    const pick = toolMap.get((a.outil||"").trim()) || themeMap.get((a.categorie||"").trim()) || "";
    if(pick){ changed++; return {...a, responsable:pick}; }
    return a;
  });
  renderMini();
  alert("Affectations: "+changed+" (local)");
}

function renderMini(){
  // liste très simple : id · action · responsable
  const html = actions.slice(0,200).map(a=>`
    <div class="row" style="border:1px solid rgba(255,255,255,.10);border-radius:14px;padding:10px;margin:8px 0;background:rgba(0,0,0,.18)">
      <div style="min-width:64px;color:var(--muted);font-weight:950">${a.id||""}</div>
      <div style="flex:1;font-weight:950">${a.action||""}</div>
      <div style="min-width:220px;color:var(--muted)">${a.responsable||"Non attribué"}</div>
    </div>
  `).join("");
  el("actionsMini").innerHTML = html || `<div class="hint">Aucune action.</div>`;
}

function showTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
  el("panelResp").style.display = name==="resp"?"block":"none";
  el("panelActions").style.display = name==="actions"?"block":"none";
  el("panelPublish").style.display = name==="publish"?"block":"none";
}
document.querySelectorAll(".tab").forEach(t=>t.addEventListener("click", ()=>showTab(t.dataset.tab)));

el("btnBack").addEventListener("click", ()=>window.location.href="./index.html");
el("btnAddResp").addEventListener("click", ()=>{
  const nom=el("newName").value.trim(); if(!nom) return;
  const email=el("newEmail").value.trim();
  responsables.push({nom,email,outils:[],themes:[]});
  el("newName").value=""; el("newEmail").value="";
  renderResp();
});
el("btnApplyAuto").addEventListener("click", applyAuto);

loadLocal();
</script>
</body></html>
