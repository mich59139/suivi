<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Communication ‚Äì Vizille en Mouvement</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bleu-vizille: #1a3a5c; --bleu-clair: #2d5a87; --or: #c9a227; --or-clair: #e8c84a;
            --blanc-casse: #f8f6f1; --gris-doux: #e8e6e1; --gris-texte: #4a4a4a;
            --vert-fait: #27ae60; --orange-encours: #f39c12; --bleu-afaire: #3498db; --rouge-bloque: #e74c3c;
            --col-siteweb: #3498db; --col-reseaux: #9b59b6; --col-papier: #e74c3c;
            --col-evenement: #1abc9c; --col-production: #e67e22; --col-presse: #34495e; --col-email: #c0392b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans 3', sans-serif; background: var(--blanc-casse); color: var(--gris-texte); }
        
        /* Header */
        .header { background: linear-gradient(135deg, var(--bleu-vizille), var(--bleu-clair)); color: white; padding: 1rem 1.5rem; }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        .logo-section { display: flex; align-items: center; gap: 1rem; }
        .logo-section img { width: 80px; height: auto; }
        .logo-text h1 { font-family: 'Playfair Display', serif; font-size: 1.3rem; }
        .logo-text .slogan { font-size: 0.85rem; color: var(--or-clair); }
        .header-stats { display: flex; gap: 1.5rem; font-size: 0.9rem; }
        .header-stats .stat { text-align: center; }
        .header-stats .stat-num { font-size: 1.5rem; font-weight: 700; display: block; }
        
        /* Onglets */
        .tabs-container { background: white; border-bottom: 1px solid var(--gris-doux); position: sticky; top: 0; z-index: 100; }
        .tabs { max-width: 1200px; margin: 0 auto; display: flex; overflow-x: auto; padding: 0; }
        .tab { padding: 1rem 1.2rem; cursor: pointer; border-bottom: 3px solid transparent; display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; transition: all 0.2s; font-weight: 500; color: var(--gris-texte); }
        .tab:hover { background: var(--blanc-casse); }
        .tab.active { border-bottom-color: var(--bleu-vizille); color: var(--bleu-vizille); font-weight: 600; }
        .tab .icon { font-size: 1.1rem; }
        .tab .badge { background: var(--gris-doux); color: var(--gris-texte); padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.75rem; font-weight: 600; }
        .tab.active .badge { background: var(--bleu-vizille); color: white; }
        
        /* Couleurs onglets actifs */
        .tab[data-axe="Site web"].active { border-bottom-color: var(--col-siteweb); color: var(--col-siteweb); }
        .tab[data-axe="Site web"].active .badge { background: var(--col-siteweb); }
        .tab[data-axe="R√©seaux sociaux"].active { border-bottom-color: var(--col-reseaux); color: var(--col-reseaux); }
        .tab[data-axe="R√©seaux sociaux"].active .badge { background: var(--col-reseaux); }
        .tab[data-axe="Supports papier"].active { border-bottom-color: var(--col-papier); color: var(--col-papier); }
        .tab[data-axe="Supports papier"].active .badge { background: var(--col-papier); }
        .tab[data-axe="√âv√©nementiel"].active { border-bottom-color: var(--col-evenement); color: var(--col-evenement); }
        .tab[data-axe="√âv√©nementiel"].active .badge { background: var(--col-evenement); }
        .tab[data-axe="Production"].active { border-bottom-color: var(--col-production); color: var(--col-production); }
        .tab[data-axe="Production"].active .badge { background: var(--col-production); }
        .tab[data-axe="Presse"].active { border-bottom-color: var(--col-presse); color: var(--col-presse); }
        .tab[data-axe="Presse"].active .badge { background: var(--col-presse); }
        .tab[data-axe="Email"].active { border-bottom-color: var(--col-email); color: var(--col-email); }
        .tab[data-axe="Email"].active .badge { background: var(--col-email); }
        
        /* Toolbar */
        .toolbar { max-width: 1200px; margin: 1rem auto; padding: 0 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
        .search-box { flex: 1; min-width: 200px; }
        .search-box input { width: 100%; padding: 0.6rem 1rem; border: 2px solid var(--gris-doux); border-radius: 8px; font-size: 0.95rem; }
        .search-box input:focus { outline: none; border-color: var(--bleu-vizille); }
        select { padding: 0.6rem 0.8rem; border: 2px solid var(--gris-doux); border-radius: 8px; font-size: 0.9rem; background: white; }
        .view-toggle { display: flex; background: var(--gris-doux); border-radius: 8px; overflow: hidden; }
        .view-btn { padding: 0.5rem 0.8rem; border: none; background: transparent; cursor: pointer; font-size: 0.85rem; }
        .view-btn.active { background: var(--bleu-vizille); color: white; }
        .btn { padding: 0.6rem 1rem; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.3rem; }
        .btn-primary { background: var(--or); color: var(--bleu-vizille); }
        .btn-secondary { background: white; border: 2px solid var(--gris-doux); }
        .btn-github { background: #24292e; color: white; }
        .btn-github.connected { background: var(--vert-fait); }
        
        /* Container */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem 2rem; }
        
        /* Vue Liste */
        .list-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        
        /* Cartes */
        .card { background: white; border-radius: 10px; padding: 1rem; cursor: pointer; border-left: 4px solid #ccc; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .card.axe-siteweb { border-left-color: var(--col-siteweb); }
        .card.axe-reseaux { border-left-color: var(--col-reseaux); }
        .card.axe-papier { border-left-color: var(--col-papier); }
        .card.axe-evenement { border-left-color: var(--col-evenement); }
        .card.axe-production { border-left-color: var(--col-production); }
        .card.axe-presse { border-left-color: var(--col-presse); }
        .card.axe-email { border-left-color: var(--col-email); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.4rem; }
        .card-id { font-size: 0.7rem; font-weight: 700; color: var(--bleu-vizille); opacity: 0.7; }
        .card-axe { font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 4px; background: var(--gris-doux); }
        .status-badge { font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 10px; color: white; font-weight: 600; }
        .status-badge.fait { background: var(--vert-fait); }
        .status-badge.encours { background: var(--orange-encours); }
        .status-badge.afaire { background: var(--bleu-afaire); }
        .status-badge.bloque { background: var(--rouge-bloque); }
        .card-title { font-weight: 600; color: var(--bleu-vizille); margin-bottom: 0.3rem; font-size: 0.95rem; line-height: 1.3; }
        .card-meta { font-size: 0.8rem; color: #888; display: flex; justify-content: space-between; align-items: center; }
        
        /* Kanban */
        .kanban { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        .kanban-col { background: white; border-radius: 10px; overflow: hidden; min-height: 300px; }
        .kanban-col-header { padding: 0.8rem; color: white; text-align: center; font-weight: 600; font-size: 0.9rem; }
        .kanban-col-header.afaire { background: var(--bleu-afaire); }
        .kanban-col-header.encours { background: var(--orange-encours); }
        .kanban-col-header.bloque { background: var(--rouge-bloque); }
        .kanban-col-header.fait { background: var(--vert-fait); }
        .kanban-col-body { padding: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; max-height: 450px; overflow-y: auto; }
        .kanban-card { background: var(--blanc-casse); padding: 0.6rem; border-radius: 6px; border-left: 3px solid #ccc; cursor: pointer; font-size: 0.85rem; }
        .kanban-card:hover { background: #eee; }
        .kanban-card.axe-siteweb { border-left-color: var(--col-siteweb); }
        .kanban-card.axe-reseaux { border-left-color: var(--col-reseaux); }
        .kanban-card.axe-papier { border-left-color: var(--col-papier); }
        .kanban-card.axe-evenement { border-left-color: var(--col-evenement); }
        .kanban-card.axe-production { border-left-color: var(--col-production); }
        .kanban-card.axe-presse { border-left-color: var(--col-presse); }
        .kanban-card.axe-email { border-left-color: var(--col-email); }
        .kanban-card-title { font-weight: 600; color: var(--bleu-vizille); }
        .kanban-card-meta { font-size: 0.75rem; color: #888; margin-top: 0.2rem; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 12px; width: 100%; max-width: 500px; max-height: 90vh; overflow: hidden; }
        .modal-header { background: var(--bleu-vizille); color: white; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-family: 'Playfair Display', serif; font-size: 1.1rem; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 30px; height: 30px; border-radius: 50%; font-size: 1.1rem; cursor: pointer; }
        .modal-body { padding: 1.5rem; overflow-y: auto; max-height: 55vh; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.3rem; color: var(--bleu-vizille); font-size: 0.85rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem; border: 2px solid var(--gris-doux); border-radius: 6px; font-size: 0.9rem; }
        .form-group textarea { min-height: 70px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .modal-footer { padding: 1rem 1.5rem; background: var(--blanc-casse); display: flex; justify-content: space-between; }
        .btn-delete { background: var(--rouge-bloque); color: white; }
        .btn-save { background: var(--vert-fait); color: white; }
        
        .sync-indicator { position: fixed; bottom: 20px; right: 20px; background: var(--bleu-vizille); color: white; padding: 0.6rem 1rem; border-radius: 8px; display: none; z-index: 999; font-size: 0.9rem; }
        .sync-indicator.show { display: block; }
        .sync-indicator.success { background: var(--vert-fait); }
        .sync-indicator.warning { background: var(--orange-encours); }
        
        .floating-btns { position: fixed; bottom: 20px; left: 20px; display: flex; gap: 10px; }
        .float-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; box-shadow: 0 3px 10px rgba(0,0,0,0.2); font-size: 1.2rem; }
        .float-btn.help { background: var(--or); color: var(--bleu-vizille); }
        .float-btn.timeline { background: var(--bleu-clair); color: white; }
        
        .empty-state { text-align: center; padding: 3rem; color: #888; }
        .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }
        
        @media (max-width: 900px) { .kanban { grid-template-columns: repeat(2, 1fr); } .tabs { padding: 0 0.5rem; } }
        @media (max-width: 600px) { 
            .kanban { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; text-align: center; }
            .list-view { grid-template-columns: 1fr; }
            .tab { padding: 0.8rem; font-size: 0.85rem; }
            .toolbar { flex-direction: column; }
            .search-box { width: 100%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="https://raw.githubusercontent.com/Vizilleenmouvement/Vizille-en-mouvement/main/images/logo.png" alt="Logo">
                <div class="logo-text">
                    <h1>Vizille en Mouvement</h1>
                    <div class="slogan">üìã Suivi Communication</div>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat"><span class="stat-num" id="stat-total">0</span>Actions</div>
                <div class="stat"><span class="stat-num" id="stat-fait">0</span>Faites</div>
                <div class="stat"><span class="stat-num" id="stat-encours">0</span>En cours</div>
            </div>
        </div>
    </header>
    
    <div class="tabs-container">
        <div class="tabs" id="tabs"></div>
    </div>
    
    <div class="toolbar">
        <div class="search-box"><input type="text" id="search" placeholder="üîç Rechercher..."></div>
        <select id="filter-responsable"><option value="">üë§ Tous</option></select>
        <select id="filter-statut">
            <option value="">üìä Tous statuts</option>
            <option value="√Ä faire">√Ä faire</option>
            <option value="En cours">En cours</option>
            <option value="Bloqu√©">Bloqu√©</option>
            <option value="Fait">Fait</option>
        </select>
        <div class="view-toggle">
            <button class="view-btn active" data-view="list">üìã Liste</button>
            <button class="view-btn" data-view="kanban">üìä Kanban</button>
        </div>
        <button class="btn btn-primary" id="btn-new">‚ûï Nouvelle</button>
        <button class="btn btn-secondary" id="btn-export">üì• CSV</button>
        <button class="btn btn-github" id="btn-github">‚öôÔ∏è <span id="gh-status">GitHub</span></button>
    </div>
    
    <div class="container" id="container"></div>
    
    <!-- Modal √©dition -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Action</h2>
                <button class="modal-close" id="modal-close">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="form-id">
                <div class="form-row">
                    <div class="form-group"><label>Axe</label><select id="form-axe"></select></div>
                    <div class="form-group"><label>Cat√©gorie</label><input type="text" id="form-categorie"></div>
                </div>
                <div class="form-group"><label>T√¢che *</label><input type="text" id="form-tache" required></div>
                <div class="form-group"><label>Description</label><textarea id="form-description"></textarea></div>
                <div class="form-row">
                    <div class="form-group"><label>Responsable</label><select id="form-responsable"></select></div>
                    <div class="form-group"><label>Statut</label><select id="form-statut"><option>√Ä faire</option><option>En cours</option><option>Bloqu√©</option><option>Fait</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Priorit√©</label><select id="form-priorite"><option>Basse</option><option>Moyenne</option><option>Haute</option></select></div>
                    <div class="form-group"><label>√âch√©ance</label><input type="date" id="form-echeance"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-delete" id="btn-delete" style="display:none">üóëÔ∏è Supprimer</button>
                <div style="flex:1"></div>
                <button class="btn btn-secondary" id="btn-cancel">Annuler</button>
                <button class="btn btn-save" id="btn-save">‚úì Enregistrer</button>
            </div>
        </div>
    </div>
    
    <!-- Modal GitHub -->
    <div class="modal-overlay" id="gh-modal">
        <div class="modal" style="max-width:400px">
            <div class="modal-header"><h2>üîê Connexion GitHub</h2><button class="modal-close" id="gh-close">√ó</button></div>
            <div class="modal-body">
                <p style="margin-bottom:1rem;background:#e8f4fc;padding:1rem;border-radius:8px;font-size:0.9rem">üìñ Mode lecture par d√©faut.<br>üîê Pour modifier, entrez le jeton.</p>
                <div class="form-group"><label>Jeton d'acc√®s</label><input type="password" id="gh-token" placeholder="ghp_xxx"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-save" id="gh-save" style="width:100%">‚úÖ Valider</button></div>
        </div>
    </div>
    
    <div class="sync-indicator" id="sync"></div>
    
    <div class="floating-btns">
        <a href="aide.html" class="float-btn help" title="Aide">‚ùì</a>
        <a href="timeline.html" class="float-btn timeline" title="Timeline">üìÖ</a>
    </div>

<script>
const REPO = 'mich59139/suivi', FILE = 'data/communication.json', BRANCH = 'main';
const AXES = [
    { id: 'all', label: 'Tous', icon: 'üìã' },
    { id: 'Site web', label: 'Site web', icon: 'üåê' },
    { id: 'R√©seaux sociaux', label: 'R√©seaux', icon: 'üì±' },
    { id: 'Supports papier', label: 'Papier', icon: 'üìÑ' },
    { id: '√âv√©nementiel', label: '√âv√©nements', icon: 'üéâ' },
    { id: 'Production', label: 'Production', icon: 'üé¨' },
    { id: 'Presse', label: 'Presse', icon: 'üì∞' },
    { id: 'Email', label: 'Email', icon: '‚úâÔ∏è' }
];

let actions = [], filtered = [], team = ['Michel','Laurent','Catherine','Ignazio','√âquipe'];
let currentView = 'list', currentAxe = 'all', editingId = null, githubSha = null;

// Utils
const getToken = () => localStorage.getItem('gh_token') || '';
const setToken = t => { t ? localStorage.setItem('gh_token', t) : localStorage.removeItem('gh_token'); updateGhBtn(); };
const isConnected = () => !!getToken();
const showSync = (msg, type='info') => { const el = document.getElementById('sync'); el.textContent = msg; el.className = 'sync-indicator show ' + type; setTimeout(() => el.classList.remove('show'), 2500); };
const statutClass = s => ({ '√Ä faire': 'afaire', 'En cours': 'encours', 'Bloqu√©': 'bloque', 'Fait': 'fait' }[s] || 'afaire');
const axeClass = a => ({ 'Site web': 'siteweb', 'R√©seaux sociaux': 'reseaux', 'Supports papier': 'papier', '√âv√©nementiel': 'evenement', 'Production': 'production', 'Presse': 'presse', 'Email': 'email' }[a] || '');

function updateGhBtn() {
    const btn = document.getElementById('btn-github');
    if (isConnected()) { btn.classList.add('connected'); document.getElementById('gh-status').textContent = '‚úì GitHub'; }
    else { btn.classList.remove('connected'); document.getElementById('gh-status').textContent = 'GitHub'; }
}

function decodeUTF8(base64) {
    const bin = atob(base64);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder('utf-8').decode(bytes);
}

function encodeUTF8(str) {
    const bytes = new TextEncoder().encode(str);
    let bin = '';
    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin);
}

async function loadData() {
    showSync('Chargement...');
    try {
        const token = getToken();
        if (token) {
            const r = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE}`, { headers: { Authorization: `token ${token}` } });
            if (r.ok) { const d = await r.json(); githubSha = d.sha; actions = JSON.parse(decodeUTF8(d.content)); }
            showSync('Sync ‚úì', 'success');
        } else {
            const r = await fetch(`https://raw.githubusercontent.com/${REPO}/${BRANCH}/${FILE}`);
            if (r.ok) actions = await r.json();
            showSync('Lecture seule', 'warning');
        }
    } catch(e) { console.error(e); showSync('Erreur', 'error'); }
    render();
}

async function saveData() {
    localStorage.setItem('actions', JSON.stringify(actions));
    const token = getToken();
    if (!token) return;
    try {
        showSync('Sauvegarde...');
        const body = { message: 'MAJ', content: encodeUTF8(JSON.stringify(actions, null, 2)), branch: BRANCH };
        if (githubSha) body.sha = githubSha;
        const r = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE}`, {
            method: 'PUT', headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body)
        });
        if (r.ok) { githubSha = (await r.json()).content.sha; showSync('Sync ‚úì', 'success'); }
    } catch(e) { console.error(e); showSync('Erreur sauvegarde', 'error'); }
}

// Onglets
function renderTabs() {
    const html = AXES.map(ax => {
        const count = ax.id === 'all' ? actions.length : actions.filter(a => a.axe === ax.id).length;
        return `<div class="tab ${currentAxe === ax.id ? 'active' : ''}" data-axe="${ax.id}">
            <span class="icon">${ax.icon}</span>
            <span class="label">${ax.label}</span>
            <span class="badge">${count}</span>
        </div>`;
    }).join('');
    document.getElementById('tabs').innerHTML = html;
    document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => { currentAxe = tab.dataset.axe; applyFilters(); renderTabs(); };
    });
}

function updateStats() {
    const base = currentAxe === 'all' ? actions : actions.filter(a => a.axe === currentAxe);
    document.getElementById('stat-total').textContent = base.length;
    document.getElementById('stat-fait').textContent = base.filter(a => a.statut === 'Fait').length;
    document.getElementById('stat-encours').textContent = base.filter(a => a.statut === 'En cours').length;
}

function updateSelects() {
    const opts = team.map(t => `<option>${t}</option>`).join('');
    document.getElementById('form-responsable').innerHTML = opts;
    document.getElementById('filter-responsable').innerHTML = '<option value="">üë§ Tous</option>' + opts;
    document.getElementById('form-axe').innerHTML = AXES.filter(a => a.id !== 'all').map(a => `<option>${a.id}</option>`).join('');
}

function applyFilters() {
    const s = document.getElementById('search').value.toLowerCase();
    const r = document.getElementById('filter-responsable').value;
    const st = document.getElementById('filter-statut').value;
    filtered = actions.filter(a => 
        (currentAxe === 'all' || a.axe === currentAxe) &&
        (!s || a.tache.toLowerCase().includes(s) || a.id.toLowerCase().includes(s)) &&
        (!r || a.responsable === r) && (!st || a.statut === st)
    );
    updateStats();
    renderView();
}

// Cartes
function renderCard(a) {
    return `<div class="card axe-${axeClass(a.axe)}" data-id="${a.id}">
        <div class="card-header">
            <span class="card-id">${a.id}</span>
            <span class="status-badge ${statutClass(a.statut)}">${a.statut}</span>
        </div>
        <div class="card-title">${a.tache}</div>
        <div class="card-meta">
            <span>üë§ ${a.responsable}</span>
            ${a.echeance ? `<span>üìÖ ${new Date(a.echeance).toLocaleDateString('fr-FR')}</span>` : ''}
        </div>
    </div>`;
}

function renderList() {
    if (filtered.length === 0) {
        return '<div class="empty-state"><div class="icon">üì≠</div><p>Aucune action trouv√©e</p></div>';
    }
    return `<div class="list-view">${filtered.map(renderCard).join('')}</div>`;
}

function renderKanban() {
    const cols = ['√Ä faire', 'En cours', 'Bloqu√©', 'Fait'];
    return `<div class="kanban">${cols.map(col => {
        const items = filtered.filter(a => a.statut === col);
        return `<div class="kanban-col">
            <div class="kanban-col-header ${statutClass(col)}">${col} (${items.length})</div>
            <div class="kanban-col-body">${items.map(a => `
                <div class="kanban-card axe-${axeClass(a.axe)}" data-id="${a.id}">
                    <div class="kanban-card-title">${a.tache}</div>
                    <div class="kanban-card-meta">üë§ ${a.responsable}</div>
                </div>`).join('')}
            </div>
        </div>`;
    }).join('')}</div>`;
}

function renderView() {
    const container = document.getElementById('container');
    container.innerHTML = currentView === 'list' ? renderList() : renderKanban();
    container.querySelectorAll('[data-id]').forEach(el => el.onclick = () => openModal(el.dataset.id));
}

function render() {
    renderTabs();
    updateSelects();
    applyFilters();
}

// Modal
function openModal(id = null) {
    editingId = id;
    const action = id ? actions.find(a => a.id === id) : null;
    document.getElementById('modal-title').textContent = action ? `Modifier ${id}` : 'Nouvelle action';
    document.getElementById('form-id').value = id || '';
    document.getElementById('form-axe').value = action?.axe || (currentAxe !== 'all' ? currentAxe : 'Site web');
    document.getElementById('form-categorie').value = action?.categorie || '';
    document.getElementById('form-tache').value = action?.tache || '';
    document.getElementById('form-description').value = action?.description || '';
    document.getElementById('form-responsable').value = action?.responsable || 'Michel';
    document.getElementById('form-statut').value = action?.statut || '√Ä faire';
    document.getElementById('form-priorite').value = action?.priorite || 'Moyenne';
    document.getElementById('form-echeance').value = action?.echeance || '';
    document.getElementById('btn-delete').style.display = action ? 'block' : 'none';
    document.getElementById('modal').classList.add('active');
}

function closeModal() { document.getElementById('modal').classList.remove('active'); editingId = null; }

function saveAction() {
    const tache = document.getElementById('form-tache').value.trim();
    if (!tache) return alert('La t√¢che est obligatoire');
    
    const data = {
        axe: document.getElementById('form-axe').value,
        categorie: document.getElementById('form-categorie').value,
        tache,
        description: document.getElementById('form-description').value,
        responsable: document.getElementById('form-responsable').value,
        statut: document.getElementById('form-statut').value,
        priorite: document.getElementById('form-priorite').value,
        echeance: document.getElementById('form-echeance').value
    };
    
    if (editingId) {
        const idx = actions.findIndex(a => a.id === editingId);
        if (idx >= 0) actions[idx] = { ...actions[idx], ...data };
    } else {
        const maxId = Math.max(...actions.map(a => parseInt(a.id.replace('COM-', '')) || 0), 0);
        data.id = `COM-${String(maxId + 1).padStart(3, '0')}`;
        actions.push(data);
    }
    
    closeModal();
    saveData();
    render();
}

function deleteAction() {
    if (!editingId || !confirm('Supprimer cette action ?')) return;
    actions = actions.filter(a => a.id !== editingId);
    closeModal();
    saveData();
    render();
}

function exportCSV() {
    const headers = ['ID', 'Axe', 'Cat√©gorie', 'T√¢che', 'Responsable', 'Statut', 'Priorit√©', '√âch√©ance'];
    const rows = filtered.map(a => [a.id, a.axe, a.categorie, a.tache, a.responsable, a.statut, a.priorite, a.echeance]);
    const csv = [headers, ...rows].map(r => r.map(c => `"${(c||'').replace(/"/g, '""')}"`).join(',')).join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `suivi-communication-${currentAxe === 'all' ? 'tous' : currentAxe.replace(/\s/g, '-')}.csv`;
    a.click();
}

// Events
document.getElementById('search').oninput = applyFilters;
document.getElementById('filter-responsable').onchange = applyFilters;
document.getElementById('filter-statut').onchange = applyFilters;
document.querySelectorAll('.view-btn').forEach(b => b.onclick = () => {
    document.querySelectorAll('.view-btn').forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    currentView = b.dataset.view;
    renderView();
});
document.getElementById('btn-new').onclick = () => openModal();
document.getElementById('btn-export').onclick = exportCSV;
document.getElementById('btn-save').onclick = saveAction;
document.getElementById('btn-cancel').onclick = closeModal;
document.getElementById('modal-close').onclick = closeModal;
document.getElementById('btn-delete').onclick = deleteAction;
document.getElementById('modal').onclick = e => { if (e.target.id === 'modal') closeModal(); };

// GitHub modal
document.getElementById('btn-github').onclick = () => document.getElementById('gh-modal').classList.add('active');
document.getElementById('gh-close').onclick = () => document.getElementById('gh-modal').classList.remove('active');
document.getElementById('gh-modal').onclick = e => { if (e.target.id === 'gh-modal') document.getElementById('gh-modal').classList.remove('active'); };
document.getElementById('gh-save').onclick = () => {
    setToken(document.getElementById('gh-token').value.trim());
    document.getElementById('gh-modal').classList.remove('active');
    loadData();
};

// Init
updateGhBtn();
loadData();
</script>
</body>
</html>
