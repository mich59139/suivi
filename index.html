<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Suivi communication — tableau vivant</title>
<style>
:root{--bg1:#061024;--bg2:#071733;--text:#eaf0ff;--muted:rgba(234,240,255,.68);--line:rgba(255,255,255,.10);--good:#2bd576;--warn:#ffb020;--bad:#ff5a6b;--info:#58a6ff;--r:18px;--shadow:0 18px 45px rgba(0,0,0,.45)}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
background:radial-gradient(1200px 700px at 10% 0%, rgba(88,166,255,.22), transparent 60%),
radial-gradient(1000px 800px at 90% 10%, rgba(43,213,118,.14), transparent 55%),
linear-gradient(180deg,var(--bg1),var(--bg2))}
header{position:sticky;top:0;z-index:30;backdrop-filter:blur(12px);background:rgba(6,16,36,.78);border-bottom:1px solid var(--line)}
.wrap{max-width:1180px;margin:0 auto;padding:14px 14px 10px}
.brand{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--line);
background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.05));border-radius:999px;box-shadow:0 10px 22px rgba(0,0,0,.25)}
.mark{width:34px;height:34px;border-radius:12px;background:radial-gradient(circle at 30% 30%,rgba(125,211,252,.9),rgba(88,166,255,.25) 60%,rgba(255,255,255,.06));
border:1px solid rgba(125,211,252,.30);position:relative}
.mark:after{content:"";position:absolute;inset:10px 8px 8px 10px;border-radius:999px;border:2px solid rgba(255,255,255,.65);transform:rotate(12deg)}
h1{margin:0;font-size:16px;font-weight:950}
.sub{margin-top:4px;color:var(--muted);font-size:12.5px;line-height:1.35}
.toprow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
input,select{background:rgba(255,255,255,.06);border:1px solid var(--line);color:var(--text);padding:9px 10px;border-radius:14px;outline:none;font-size:13px}
.btn{border:1px solid var(--line);background:rgba(255,255,255,.08);color:var(--text);padding:9px 10px;border-radius:14px;cursor:pointer;font-weight:950;font-size:13px}
.btn.primary{border-color:rgba(125,211,252,.35);background:rgba(125,211,252,.12)}
.pill{display:inline-flex;align-items:center;gap:7px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.15);color:var(--muted);font-weight:900;font-size:12px}
.dot{width:8px;height:8px;border-radius:50%}
.dot.good{background:var(--good)}.dot.warn{background:var(--warn)}.dot.bad{background:var(--bad)}.dot.info{background:var(--info)}
main{max-width:1180px;margin:0 auto;padding:14px}
.grid{display:grid;gap:14px;grid-template-columns:1fr}
@media(min-width:980px){.grid{grid-template-columns:360px 1fr}}
.card{border:1px solid var(--line);border-radius:var(--r);background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.05));box-shadow:var(--shadow);overflow:hidden}
.card h2{margin:0;padding:14px 14px 0;font-size:12.5px;letter-spacing:.35px;text-transform:uppercase;color:var(--muted);font-weight:950}
.card .content{padding:12px 14px 14px}
.hint{color:var(--muted);font-size:12px;line-height:1.35}
.kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.kpi{border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.20);padding:10px}
.kpi .n{margin:0;font-size:24px;font-weight:950}
.cards{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:720px){.cards{grid-template-columns:repeat(2,1fr)}}
@media(min-width:1060px){.cards{grid-template-columns:repeat(3,1fr)}}
.tile{border:1px solid var(--line);border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.05));box-shadow:0 14px 32px rgba(0,0,0,.35);overflow:hidden;cursor:pointer;position:relative}
.tile .bar{height:7px;background:var(--col);opacity:.95}
.tile .b{padding:12px}
.tile .title{font-weight:950}
.tile .meta{margin-top:4px;color:var(--muted);font-size:12px}
.metrics{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.metric{border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);border-radius:999px;padding:5px 8px;font-size:11px;color:var(--muted);font-weight:950}
.metric b{color:var(--text)}
.metric.bad b{color:var(--bad)}.metric.warn b{color:var(--warn)}.metric.info b{color:var(--info)}
.breadcrumb{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
.crumb{border:1px solid var(--line);background:rgba(255,255,255,.06);padding:7px 10px;border-radius:999px;cursor:pointer;font-weight:950;font-size:12.5px;color:var(--text)}
.crumb.muted{color:var(--muted)}
details.action{border:1px solid rgba(255,255,255,.12);border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.05));margin:10px 0;overflow:hidden;border-left:6px solid var(--col, rgba(255,255,255,.12))}
details.action>summary{list-style:none;cursor:pointer;padding:10px;display:flex;flex-direction:column;gap:6px}
details.action>summary::-webkit-details-marker{display:none}
.aTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
.aId{font-weight:900;font-size:12px;color:var(--muted)}
.aTitle{font-weight:950}
.aPills{display:flex;gap:8px;flex-wrap:wrap}
.aBody{border-top:1px solid rgba(255,255,255,.10);padding:10px}
.kv{display:grid;grid-template-columns:120px 1fr;gap:6px 10px;font-size:13px}
.kv div:nth-child(odd){color:var(--muted);font-weight:950}
.badgeLate{color:var(--bad);font-weight:950}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="logo">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <h1>Suivi communication — tableau vivant</h1>
          <div class="sub">Très simple : choisir <b>par Outil</b>, <b>par Responsable</b> ou <b>par Thème</b> → puis ouvrir les actions.</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <span class="pill"><span class="dot info"></span><span id="src">source: —</span></span>
        <span class="pill"><span class="dot good"></span><span id="sync">synchro: —</span></span>
        <button class="btn primary" id="btnAdmin">Admin</button>
      </div>
    </div>

    <div class="toprow">
      <input id="q" type="search" placeholder="Rechercher (action, id, notes…)" style="flex:1; min-width:240px">
      <select id="fTool"><option value="">Outil (tous)</option></select>
      <select id="fTheme"><option value="">Thème (tous)</option></select>
      <select id="fResp"><option value="">Responsable (tous)</option></select>
      <select id="fStat"><option value="">Statut (tous)</option></select>
      <select id="fPrio"><option value="">Priorité (toutes)</option></select>
      <button class="btn" id="btnReset">Réinitialiser</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>Indicateurs</h2>
      <div class="content">
        <div class="kpis" id="kpis"></div>
        <div class="hint" id="hint" style="margin-top:10px"></div>
      </div>
      <h2>Mode d’emploi</h2>
      <div class="content">
        <div class="hint">
          • Clique une grande carte (Outil / Responsable / Thème).<br>
          • Clique une action pour voir le détail.<br>
          • Pour attribuer des responsables “par domaines” : bouton <b>Admin</b>.
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Tableau</h2>
      <div class="content">
        <div class="breadcrumb" id="crumbs"></div>
        <div id="view"></div>
      </div>
    </section>
  </div>
</main>

<script>
const STATUTS=["À faire","En cours","Bloqué","Fait","En retard"];
const PRIOS=["P1","P2","P3"];
const REFRESH_MS=20000;
const el=id=>document.getElementById(id);

let actions=[], responsables=[], lastUpdatedAt=null;
let nav={mode:"home", dim:null, key:null}; // home | pick | list

function todayISO(){ const d=new Date(), tz=d.getTimezoneOffset()*60000; return new Date(d-tz).toISOString().slice(0,10); }
function isLate(t){ return t.echeance && t.statut!=="Fait" && t.echeance < todayISO(); }
function dotClass(st){ return st==="Fait"?"good":st==="En cours"?"info":st==="Bloqué"?"warn":st==="En retard"?"bad":""; }
function colorFor(str, seed){ const s=(seed+":"+ (str||"")).toLowerCase(); let h=0; for(let i=0;i<s.length;i++) h=((h<<5)-h)+s.charCodeAt(i), h|=0; return `hsl(${Math.abs(h)%360} 78% 55%)`; }
function unique(list,key){ return [...new Set(list.map(x=>x[key]).filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }
function withAutoStatus(list){ return list.map(x=>{ const late=isLate(x); return late && x.statut!=="En retard" ? {...x, statutAuto:"En retard"} : {...x, statutAuto:x.statut}; }); }

function applyFilters(list){
  const q=el("q").value.trim().toLowerCase();
  const tool=el("fTool").value, theme=el("fTheme").value, resp=el("fResp").value, stat=el("fStat").value, prio=el("fPrio").value;
  return withAutoStatus(list).filter(x=>{
    if(tool && (x.outil||"")!==tool) return false;
    if(theme && (x.categorie||"")!==theme) return false;
    if(resp && (x.responsable||"")!==resp) return false;
    if(stat && (x.statut||"")!==stat) return false;
    if(prio && (x.priorite||"")!==prio) return false;
    if(q){
      const blob=`${x.id} ${x.outil||""} ${x.categorie||""} ${x.action||""} ${x.responsable||""} ${x.notes||""}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    return true;
  });
}

function fillFilters(){
  el("fTool").innerHTML = `<option value="">Outil (tous)</option>` + unique(actions,"outil").map(t=>`<option value="${t}">${t}</option>`).join("");
  el("fTheme").innerHTML = `<option value="">Thème (tous)</option>` + unique(actions,"categorie").map(t=>`<option value="${t}">${t}</option>`).join("");

  const respNames = unique(responsables,"nom");
  const fromActions = unique(actions,"responsable").filter(x=>x && x!=="—" && x!=="-");
  const all = [...new Set([...respNames, ...fromActions])].sort((a,b)=>a.localeCompare(b));
  el("fResp").innerHTML = `<option value="">Responsable (tous)</option>` + all.map(r=>`<option value="${r}">${r}</option>`).join("");

  el("fStat").innerHTML = `<option value="">Statut (tous)</option>` + STATUTS.map(s=>`<option value="${s}">${s}</option>`).join("");
  el("fPrio").innerHTML = `<option value="">Priorité (toutes)</option>` + PRIOS.map(p=>`<option value="${p}">${p}</option>`).join("");
}

function renderKpis(list){
  const by=s=>list.filter(x=>x.statutAuto===s).length;
  const late=list.filter(x=>isLate(x)).length;
  const k=[
    {n:list.length,l:"Actions (vue)"},
    {n:by("Fait"),l:"Fait",c:"good"},
    {n:by("En cours"),l:"En cours",c:"info"},
    {n:by("Bloqué"),l:"Bloqué",c:"warn"},
    {n:late,l:"En retard",c:"bad"},
  ];
  el("kpis").innerHTML = k.map(x=>`
    <div class="kpi">
      <div class="pill"><span class="dot ${x.c||""}"></span>${x.l}</div>
      <p class="n">${x.n}</p>
    </div>
  `).join("");
  const updated = lastUpdatedAt ? new Date(lastUpdatedAt).toLocaleString() : "—";
  el("hint").innerHTML = `Dernière lecture : <b>${updated}</b>`;
}

function setCrumbs(){
  const items=[];
  items.push({label:"Accueil", action:()=>{nav={mode:"home",dim:null,key:null}; render();}});
  if(nav.dim) items.push({label: nav.dim==="outil"?"Par outil":nav.dim==="responsable"?"Par responsable":"Par thème", action:()=>{nav={mode:"pick",dim:nav.dim,key:null}; render();}});
  if(nav.key) items.push({label: nav.key, action:()=>{nav={mode:"list",dim:nav.dim,key:nav.key}; render();}});
  el("crumbs").innerHTML = items.map((x,i)=>`<div class="crumb ${i===items.length-1?"":"muted"}" data-i="${i}">${x.label}</div>`).join("");
  [...el("crumbs").querySelectorAll(".crumb")].forEach((node,i)=>node.addEventListener("click", ()=>items[i].action()));
}

function metricBlock(items){
  const late=items.filter(x=>isLate(x)).length;
  const blocked=items.filter(x=>x.statutAuto==="Bloqué").length;
  const p1=items.filter(x=>x.priorite==="P1" && x.statutAuto!=="Fait").length;
  return `<div class="metrics">
    <span class="metric info">P1 <b>${p1}</b></span>
    <span class="metric warn">Bloqué <b>${blocked}</b></span>
    <span class="metric bad">Retard <b>${late}</b></span>
  </div>`;
}

function renderHome(list){
  el("view").innerHTML = `
    <div class="hint" style="margin-bottom:10px">Choisis une vue :</div>
    <div class="cards">
      <div class="tile" style="--col:${colorFor('outil','d')}" data-dim="outil"><div class="bar"></div><div class="b">
        <div class="title">Par outil</div><div class="meta">Terrain · Prospectus · Réunions · Réseaux · Site</div>
      </div></div>
      <div class="tile" style="--col:${colorFor('responsable','d')}" data-dim="responsable"><div class="bar"></div><div class="b">
        <div class="title">Par responsable</div><div class="meta">Qui fait quoi</div>
      </div></div>
      <div class="tile" style="--col:${colorFor('theme','d')}" data-dim="theme"><div class="bar"></div><div class="b">
        <div class="title">Par thème</div><div class="meta">Bilans & programme</div>
      </div></div>
    </div>
  `;
  [...el("view").querySelectorAll(".tile")].forEach(t=>t.addEventListener("click", ()=>{
    nav={mode:"pick", dim:t.dataset.dim, key:null}; render();
  }));
}

function renderPick(list){
  const dim=nav.dim;
  const map=new Map();
  for(const it of list){
    const k = dim==="outil" ? (it.outil||"Sans outil") : dim==="theme" ? (it.categorie||"Sans thème") : (it.responsable||"Non attribué");
    if(!map.has(k)) map.set(k,[]);
    map.get(k).push(it);
  }
  let groups=[...map.entries()];
  groups.sort((a,b)=>{
    if(dim==="responsable"){
      if(a[0]==="Non attribué") return -1;
      if(b[0]==="Non attribué") return 1;
    }
    return a[0].localeCompare(b[0]);
  });

  const tiles = groups.map(([k, items])=>{
    const col=colorFor(k, dim);
    return `<div class="tile" style="--col:${col}" data-key="${k.replace(/"/g,'&quot;')}">
      <div class="bar"></div><div class="b">
        <div class="title">${k}</div>
        <div class="meta">${items.length} action(s)</div>
        ${metricBlock(items)}
      </div></div>`;
  }).join("");

  el("view").innerHTML = `<div class="hint" style="margin-bottom:10px">Clique une carte :</div><div class="cards">${tiles}</div>`;
  [...el("view").querySelectorAll(".tile")].forEach(t=>t.addEventListener("click", ()=>{
    nav={mode:"list", dim, key:t.dataset.key}; render();
  }));
}

function renderList(list){
  const dim=nav.dim, key=nav.key;
  let subset=list;
  if(dim==="outil") subset=list.filter(x=>(x.outil||"Sans outil")===key);
  else if(dim==="theme") subset=list.filter(x=>(x.categorie||"Sans thème")===key);
  else subset=list.filter(x=>(x.responsable||"Non attribué")===key);

  subset=subset.slice().sort((a,b)=>{
    const al=isLate(a), bl=isLate(b);
    if(al!==bl) return al?-1:1;
    return (a.echeance||"9999-12-31").localeCompare(b.echeance||"9999-12-31");
  });

  function actionCard(t){
    const col=colorFor(key, dim);
    const st=t.statutAuto;
    const ech=t.echeance ? (isLate(t)?`<span class="badgeLate">${t.echeance}</span>`:t.echeance) : "—";
    return `<details class="action" style="--col:${col}"><summary>
      <div class="aTop"><div class="aId">${t.id} · ${t.outil||"—"} · ${t.categorie||"—"} · ${t.responsable||"Non attribué"}</div>
      <span class="pill"><span class="dot ${dotClass(st)}"></span>${st}</span></div>
      <div class="aTitle">${t.action}</div>
      <div class="aPills"><span class="pill">Prio: ${t.priorite||"—"}</span><span class="pill">Éch: ${ech}</span></div>
    </summary><div class="aBody"><div class="kv"><div>Notes</div><div>${t.notes||"—"}</div><div>Dépendance</div><div>${t.dependance||"—"}</div></div></div></details>`;
  }
  el("view").innerHTML = `<div class="hint" style="margin-bottom:10px"><b>${key}</b> — actions :</div>` + (subset.length?subset.map(actionCard).join(""):`<div class="hint">Aucune action.</div>`);
}

function render(){
  const list=applyFilters(actions);
  setCrumbs();
  renderKpis(list);
  if(nav.mode==="home") renderHome(list);
  else if(nav.mode==="pick") renderPick(list);
  else renderList(list);
}
function resetAll(){
  el("q").value=""; el("fTool").value=""; el("fTheme").value=""; el("fResp").value=""; el("fStat").value=""; el("fPrio").value="";
  nav={mode:"home",dim:null,key:null}; render();
}

async function loadLocal(){
  const a=await fetch("./data.json?ts="+Date.now()).then(r=>r.json());
  const r=await fetch("./responsables.json?ts="+Date.now()).then(r=>r.json()).catch(()=>[]);
  actions=Array.isArray(a)?a:[];
  responsables=Array.isArray(r)?r:[];
  lastUpdatedAt=Date.now();
  fillFilters(); render();
  el("src").textContent="source: GitHub Pages";
  el("sync").textContent="synchro: OK";
}

el("btnReset").addEventListener("click", resetAll);
["q","fTool","fTheme","fResp","fStat","fPrio"].forEach(id=>el(id).addEventListener("input", render));
el("btnAdmin").addEventListener("click", ()=>window.location.href="./admin.html");

loadLocal();
setInterval(loadLocal, REFRESH_MS);
</script>
</body>
</html>
