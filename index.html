<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Communication ‚Äì Vizille en Mouvement</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root {
            --bleu-vizille: #1a3a5c; --bleu-clair: #2d5a87; --or: #c9a227; --or-clair: #e8c84a;
            --blanc-casse: #f8f6f1; --gris-doux: #e8e6e1; --gris-texte: #4a4a4a;
            --vert-fait: #27ae60; --orange-encours: #f39c12; --bleu-afaire: #3498db; --rouge-bloque: #e74c3c; --violet-haute: #9b59b6;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08); --shadow-md: 0 4px 12px rgba(0,0,0,0.12); --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
            --radius-sm: 8px; --radius-md: 12px; --radius-lg: 20px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--blanc-casse); color: var(--gris-texte); line-height: 1.6; }
        
        .header { background: linear-gradient(135deg, var(--bleu-vizille) 0%, var(--bleu-clair) 100%); color: white; padding: 1.5rem; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); opacity: 0.5; }
        .header-content { max-width: 1200px; margin: 0 auto; position: relative; z-index: 1; }
        .header-top { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        .logo-section { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { width: 120px; height: auto; }
        .logo-icon img { width: 100%; height: auto; }
        .logo-text h1 { font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 700; }
        .logo-text .slogan { font-size: 0.95rem; color: var(--or-clair); font-weight: 600; }
        .page-title { background: rgba(255,255,255,0.15); padding: 0.5rem 1.25rem; border-radius: 30px; border: 1px solid rgba(255,255,255,0.3); font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        
        .stats-bar { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1.25rem; justify-content: center; }
        .stat-chip { background: rgba(255,255,255,0.12); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 25px; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s ease; cursor: pointer; }
        .stat-chip:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }
        .stat-chip.active { background: var(--or); color: var(--bleu-vizille); font-weight: 600; }
        .stat-number { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.1rem; }
        .stat-chip.afaire .stat-number { color: var(--bleu-afaire); }
        .stat-chip.encours .stat-number { color: var(--orange-encours); }
        .stat-chip.bloque .stat-number { color: var(--rouge-bloque); }
        .stat-chip.fait .stat-number { color: var(--vert-fait); }
        .stat-chip.haute .stat-number { color: var(--violet-haute); }
        .stat-chip.active .stat-number { color: var(--bleu-vizille); }
        
        .toolbar { max-width: 1200px; margin: 1.5rem auto; padding: 0 1rem; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
        .search-box { flex: 1; min-width: 200px; position: relative; }
        .search-box input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.75rem; border: 2px solid var(--gris-doux); border-radius: var(--radius-md); font-size: 1rem; font-family: inherit; background: white; transition: all 0.3s ease; }
        .search-box input:focus { outline: none; border-color: var(--bleu-vizille); box-shadow: 0 0 0 3px rgba(26, 58, 92, 0.1); }
        .search-box::before { content: 'üîç'; position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); font-size: 1rem; opacity: 0.5; }
        .filter-select { padding: 0.75rem 2rem 0.75rem 1rem; border: 2px solid var(--gris-doux); border-radius: var(--radius-md); font-size: 0.95rem; font-family: inherit; background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%234a4a4a' d='M6 8L1 3h10z'/%3E%3C/svg%3E") no-repeat right 0.75rem center; appearance: none; cursor: pointer; min-width: 140px; }
        .filter-select:focus { outline: none; border-color: var(--bleu-vizille); }
        .view-toggle { display: flex; background: var(--gris-doux); border-radius: var(--radius-md); overflow: hidden; }
        .view-btn { padding: 0.75rem 1rem; border: none; background: transparent; cursor: pointer; font-size: 1.1rem; transition: all 0.2s ease; }
        .view-btn.active { background: var(--bleu-vizille); color: white; }
        
        .btn-action { padding: 0.75rem 1.25rem; border: none; border-radius: var(--radius-md); font-size: 0.95rem; font-family: inherit; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, var(--or) 0%, var(--or-clair) 100%); color: var(--bleu-vizille); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-secondary { background: white; color: var(--bleu-vizille); border: 2px solid var(--gris-doux); }
        .btn-secondary:hover { border-color: var(--bleu-vizille); }
        .btn-team { background: var(--bleu-clair); color: white; border: none; }
        .btn-team:hover { background: var(--bleu-vizille); }
        .btn-group { background: var(--violet-haute); color: white; border: none; }
        .btn-group:hover { background: #8e44ad; }
        .btn-alert { background: var(--rouge-bloque); color: white; border: none; }
        .btn-alert:hover { background: #c0392b; }
        .btn-whatsapp { background: #25D366; color: white; border: none; }
        .btn-whatsapp:hover { background: #128C7E; }
        .btn-github { background: #24292e; color: white; border: none; }
        .btn-github:hover { background: #1a1e22; }
        .btn-github.connected { background: var(--vert-fait); }
        
        .sync-indicator { position: fixed; bottom: 20px; right: 20px; background: var(--bleu-vizille); color: white; padding: 0.75rem 1.25rem; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); display: none; align-items: center; gap: 0.5rem; z-index: 1000; font-weight: 500; }
        .sync-indicator.show { display: flex; animation: slideIn 0.3s ease; }
        .sync-indicator.success { background: var(--vert-fait); }
        .sync-indicator.error { background: var(--rouge-bloque); }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .cards-container { max-width: 1200px; margin: 0 auto; padding: 0 1rem 2rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.25rem; }
        .action-card { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); overflow: hidden; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; }
        .action-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--or); }
        .card-header { padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem; }
        .card-id { font-family: 'Playfair Display', serif; font-size: 0.85rem; font-weight: 700; color: var(--bleu-vizille); background: var(--gris-doux); padding: 0.25rem 0.6rem; border-radius: 6px; }
        .card-badges { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .badge { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 20px; font-weight: 600; }
        .badge-statut { color: white; }
        .badge-statut.afaire { background: var(--bleu-afaire); }
        .badge-statut.encours { background: var(--orange-encours); }
        .badge-statut.bloque { background: var(--rouge-bloque); }
        .badge-statut.fait { background: var(--vert-fait); }
        .badge-priorite { background: rgba(155, 89, 182, 0.15); color: var(--violet-haute); }
        .card-body { padding: 0 1.25rem 1rem; }
        .card-title { font-weight: 600; color: var(--bleu-vizille); margin-bottom: 0.5rem; font-size: 1rem; line-height: 1.4; }
        .card-description { font-size: 0.9rem; color: var(--gris-texte); opacity: 0.85; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-footer { padding: 0.75rem 1.25rem; background: var(--blanc-casse); display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        .card-meta { display: flex; align-items: center; gap: 0.5rem; color: var(--gris-texte); }
        .card-axe { background: var(--bleu-vizille); color: white; padding: 0.2rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
        
        .table-container { max-width: 1200px; margin: 0 auto; padding: 0 1rem 2rem; display: none; }
        .table-container.active { display: block; }
        .data-table { width: 100%; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); overflow: hidden; border-collapse: collapse; }
        .data-table th { background: var(--bleu-vizille); color: white; padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; }
        .data-table td { padding: 0.875rem 1rem; border-bottom: 1px solid var(--gris-doux); vertical-align: middle; }
        .data-table tr { cursor: pointer; transition: background 0.2s ease; }
        .data-table tbody tr:hover { background: rgba(201, 162, 39, 0.08); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(26, 58, 92, 0.8); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; padding: 1rem; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; border-radius: var(--radius-lg); width: 100%; max-width: 600px; max-height: 90vh; overflow: hidden; transform: translateY(20px) scale(0.95); transition: transform 0.3s ease; display: flex; flex-direction: column; }
        .modal-overlay.active .modal { transform: translateY(0) scale(1); }
        .modal-header { background: linear-gradient(135deg, var(--bleu-vizille) 0%, var(--bleu-clair) 100%); color: white; padding: 1.25rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-family: 'Playfair Display', serif; font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .modal-close { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 1.25rem; cursor: pointer; }
        .modal-close:hover { background: rgba(255,255,255,0.3); }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-weight: 600; color: var(--bleu-vizille); margin-bottom: 0.5rem; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--gris-doux); border-radius: var(--radius-sm); font-size: 1rem; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--bleu-vizille); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .modal-footer { padding: 1rem 1.5rem; background: var(--blanc-casse); display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .btn-delete { background: var(--rouge-bloque); color: white; }
        .btn-save { background: linear-gradient(135deg, var(--vert-fait) 0%, #2ecc71 100%); color: white; }
        .btn-cancel { background: white; color: var(--gris-texte); border: 2px solid var(--gris-doux); padding: 0.75rem 1.25rem; border-radius: var(--radius-md); font-size: 0.95rem; font-family: inherit; font-weight: 600; cursor: pointer; }
        
        .member-list { list-style: none; max-height: 400px; overflow-y: auto; }
        .member-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; background: var(--blanc-casse); border-radius: var(--radius-sm); margin-bottom: 0.5rem; }
        .member-item:hover { background: var(--gris-doux); }
        .member-info { flex: 1; }
        .member-name { font-weight: 600; color: var(--bleu-vizille); display: flex; align-items: center; gap: 0.5rem; }
        .member-name::before { content: 'üë§'; }
        .member-contact { font-size: 0.85rem; color: var(--gris-texte); margin-top: 0.25rem; }
        .member-contact a { color: var(--bleu-clair); text-decoration: none; }
        .btn-remove-member { background: transparent; border: none; color: var(--rouge-bloque); font-size: 1.25rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; }
        .add-member-form { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--gris-doux); }
        .add-member-form.simple { grid-template-columns: 1fr auto; }
        .add-member-form input { padding: 0.75rem 1rem; border: 2px solid var(--gris-doux); border-radius: var(--radius-sm); font-size: 0.9rem; font-family: inherit; }
        .btn-add-member { background: var(--vert-fait); color: white; border: none; padding: 0.75rem 1rem; border-radius: var(--radius-sm); font-size: 1rem; cursor: pointer; }
        .count-info { text-align: center; color: var(--gris-texte); font-size: 0.9rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--gris-doux); }
        .count-info strong { color: var(--bleu-vizille); font-family: 'Playfair Display', serif; }
        
        .alert-header { background: linear-gradient(135deg, var(--rouge-bloque) 0%, #c0392b 100%) !important; }
        .group-header { background: linear-gradient(135deg, var(--violet-haute) 0%, #8e44ad 100%) !important; }
        
        /* S√©lection destinataires */
        .recipients-selection { margin: 1rem 0; }
        .recipients-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .recipients-header h4 { color: var(--bleu-vizille); font-size: 0.95rem; }
        .recipients-actions { display: flex; gap: 0.5rem; }
        .recipients-actions button { background: var(--gris-doux); border: none; padding: 0.4rem 0.75rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-family: inherit; }
        .recipients-actions button:hover { background: var(--bleu-vizille); color: white; }
        .recipients-list { max-height: 200px; overflow-y: auto; border: 2px solid var(--gris-doux); border-radius: var(--radius-sm); padding: 0.5rem; }
        .recipient-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: 4px; cursor: pointer; }
        .recipient-item:hover { background: var(--blanc-casse); }
        .recipient-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--bleu-vizille); }
        .recipient-item label { flex: 1; cursor: pointer; font-size: 0.9rem; }
        .recipient-item .email { color: var(--gris-texte); font-size: 0.8rem; }
        .selected-count { background: var(--or); color: var(--bleu-vizille); padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; }
        
        .sending-status { margin-top: 1rem; padding: 1rem; border-radius: var(--radius-sm); display: none; }
        .sending-status.show { display: block; }
        .sending-status.sending { background: #fff3cd; color: #856404; }
        .sending-status.success { background: #d4edda; color: #155724; }
        .sending-status.error { background: #f8d7da; color: #721c24; }
        
        .alert-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .chart-section { max-width: 1200px; margin: 0 auto 1.5rem; padding: 0 1rem; }
        .chart-card { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 1.5rem; }
        .chart-card h3 { font-family: 'Playfair Display', serif; color: var(--bleu-vizille); margin-bottom: 1rem; text-align: center; }
        .chart-container { display: flex; gap: 2rem; align-items: center; flex-wrap: wrap; }
        .chart-wrapper { flex: 1; min-width: 200px; max-width: 300px; margin: 0 auto; }
        .chart-legend { flex: 1; min-width: 200px; }
        .legend-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; border-radius: var(--radius-sm); cursor: pointer; }
        .legend-item:hover { background: var(--blanc-casse); }
        .legend-color { width: 16px; height: 16px; border-radius: 4px; }
        .legend-label { flex: 1; font-weight: 500; }
        .legend-value { font-family: 'Playfair Display', serif; font-weight: 700; color: var(--bleu-vizille); }
        
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--gris-texte); }
        .empty-state-icon { font-size: 4rem; opacity: 0.3; margin-bottom: 1rem; }
        .empty-state h3 { font-family: 'Playfair Display', serif; color: var(--bleu-vizille); }
        
        @media (max-width: 768px) {
            .header-top, .logo-section { flex-direction: column; text-align: center; }
            .toolbar { flex-direction: column; }
            .search-box { width: 100%; }
            .cards-container { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .modal-footer { flex-direction: column; }
            .add-member-form { grid-template-columns: 1fr; }
            .alert-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-top">
                <div class="logo-section">
                    <div class="logo-icon">
                        <img src="https://raw.githubusercontent.com/mich59139/Vizille-en-mouvement2/main/images/logo.png" alt="Vizille en Mouvement">
                    </div>
                    <div class="logo-text">
                        <h1>Vizille en Mouvement</h1>
                        <div class="slogan">Ensemble pour une ville dynamique et solidaire</div>
                    </div>
                </div>
                <div class="page-title"><span>üìã</span><span>Suivi Communication</span></div>
            </div>
            <div class="stats-bar" id="stats-bar"></div>
        </div>
    </header>
    
    <div class="toolbar">
        <div class="search-box"><input type="text" id="search-input" placeholder="Rechercher une action..."></div>
        <select class="filter-select" id="filter-responsable"><option value="">Tous responsables</option></select>
        <select class="filter-select" id="filter-axe"><option value="">Tous les axes</option></select>
        <div class="view-toggle">
            <button class="view-btn active" data-view="cards">üÉè</button>
            <button class="view-btn" data-view="table">üìä</button>
        </div>
        <button class="btn-action btn-primary" id="btn-new"><span>‚ûï</span><span>Nouvelle</span></button>
        <button class="btn-action btn-team" id="btn-team"><span>üë•</span><span>√âquipe</span></button>
        <button class="btn-action btn-group" id="btn-group"><span>üì¢</span><span>Groupe</span></button>
        <button class="btn-action btn-alert" id="btn-alert"><span>üö®</span><span>Alerte</span></button>
        <button class="btn-action btn-secondary" id="btn-export"><span>üì•</span><span>CSV</span></button>
        <button class="btn-action btn-secondary" id="btn-import"><span>üì§</span><span>Import</span></button>
        <input type="file" id="import-file" accept=".json,.csv" style="display:none">
        <button class="btn-action btn-github" id="btn-github"><span>‚öôÔ∏è</span><span id="github-status">GitHub</span></button>
    </div>
    
    <!-- TEAM MODAL -->
    <div class="modal-overlay" id="team-modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header"><h2>üë• √âquipe Communication</h2><button class="modal-close" id="team-modal-close">√ó</button></div>
            <div class="modal-body">
                <p style="margin-bottom:1rem;color:var(--gris-texte);font-size:0.9rem;">Responsables des actions.</p>
                <div class="count-info"><strong id="team-count">0</strong> membres</div>
                <ul class="member-list" id="team-list"></ul>
                <div class="add-member-form simple">
                    <input type="text" id="new-team-member" placeholder="Nom du membre">
                    <button class="btn-add-member" id="btn-add-team-member">‚ûï</button>
                </div>
            </div>
            <div class="modal-footer"><div style="flex:1"></div><button class="btn-cancel" id="team-modal-done">Termin√©</button></div>
        </div>
    </div>
    
    <!-- GROUP MODAL -->
    <div class="modal-overlay" id="group-modal-overlay">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header group-header"><h2>üì¢ Groupe complet</h2><button class="modal-close" id="group-modal-close">√ó</button></div>
            <div class="modal-body">
                <p style="margin-bottom:1rem;color:var(--gris-texte);font-size:0.9rem;">Tous les membres (pour les alertes).</p>
                <div class="count-info"><strong id="members-count">0</strong> membres</div>
                <ul class="member-list" id="members-list"></ul>
                <div class="add-member-form">
                    <input type="text" id="new-member-name" placeholder="Nom">
                    <input type="email" id="new-member-email" placeholder="Email">
                    <input type="tel" id="new-member-phone" placeholder="T√©l√©phone">
                    <button class="btn-add-member" id="btn-add-member">‚ûï</button>
                </div>
            </div>
            <div class="modal-footer"><div style="flex:1"></div><button class="btn-cancel" id="group-modal-done">Termin√©</button></div>
        </div>
    </div>
    
    <!-- ALERT MODAL -->
    <div class="modal-overlay" id="alert-modal-overlay">
        <div class="modal" style="max-width: 650px;">
            <div class="modal-header alert-header"><h2>üö® Alerte</h2><button class="modal-close" id="alert-modal-close">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label for="alert-subject">Objet</label><input type="text" id="alert-subject" placeholder="[URGENT] Vizille en Mouvement - ..."></div>
                <div class="form-group"><label for="alert-message">Message</label><textarea id="alert-message" placeholder="Votre message..." style="min-height: 120px;"></textarea></div>
                
                <div class="recipients-selection">
                    <div class="recipients-header">
                        <h4>üìß Destinataires <span class="selected-count" id="selected-count">0</span></h4>
                        <div class="recipients-actions">
                            <button id="btn-select-all">Tout s√©lectionner</button>
                            <button id="btn-deselect-all">Tout d√©s√©lectionner</button>
                        </div>
                    </div>
                    <div class="recipients-list" id="recipients-list"></div>
                </div>
                
                <div class="sending-status" id="sending-status"></div>
            </div>
            <div class="modal-footer">
                <div style="flex:1"></div>
                <button class="btn-cancel" id="alert-modal-cancel">Annuler</button>
                <div class="alert-buttons">
                    <button class="btn-action btn-whatsapp" id="btn-copy-whatsapp"><span>üìã</span><span>Copier WhatsApp</span></button>
                    <button class="btn-action btn-alert" id="btn-send-email"><span>üìß</span><span>Envoyer Email</span></button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CATEGORIES MODAL -->
    <div class="modal-overlay" id="categories-modal-overlay">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header"><h2>üè∑Ô∏è Cat√©gories</h2><button class="modal-close" id="categories-modal-close">√ó</button></div>
            <div class="modal-body">
                <div class="count-info"><strong id="categories-count">0</strong> cat√©gories</div>
                <ul class="member-list" id="categories-list"></ul>
                <div class="add-member-form simple">
                    <input type="text" id="new-category-name" placeholder="Nouvelle cat√©gorie">
                    <button class="btn-add-member" id="btn-add-category">‚ûï</button>
                </div>
            </div>
            <div class="modal-footer"><div style="flex:1"></div><button class="btn-cancel" id="categories-modal-done">Termin√©</button></div>
        </div>
    </div>
    
    <!-- GITHUB MODAL -->
    <div class="modal-overlay" id="github-modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header"><h2>‚öôÔ∏è GitHub</h2><button class="modal-close" id="github-modal-close">√ó</button></div>
            <div class="modal-body">
                <div class="form-group"><label for="github-token">Token GitHub</label><input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx"></div>
                <div class="form-group"><label>Repository</label><input type="text" value="mich59139/suivi" readonly style="background: #f0f0f0;"></div>
                <div id="github-connection-status" style="margin: 1rem 0; padding: 0.75rem; border-radius: 8px; display: none;"></div>
            </div>
            <div class="modal-footer"><button class="btn-cancel" id="github-disconnect">D√©connecter</button><button class="btn-action btn-save" id="github-test">Tester</button><button class="btn-action btn-save" id="github-save-config" style="background: var(--vert-fait);">Sauvegarder</button></div>
        </div>
    </div>
    
    <div class="chart-section"><div class="chart-card"><h3>üìä R√©partition</h3><div class="chart-container"><div class="chart-wrapper"><canvas id="statusChart"></canvas></div><div class="chart-legend" id="chart-legend"></div></div></div></div>
    <div class="cards-container" id="cards-container"></div>
    <div class="table-container" id="table-container"><table class="data-table"><thead><tr><th>ID</th><th>T√¢che</th><th>Responsable</th><th>Statut</th><th>Priorit√©</th><th>Axe</th></tr></thead><tbody id="table-body"></tbody></table></div>
    
    <!-- ACTION MODAL -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h2><span id="modal-icon">üìù</span> <span id="modal-title">Action</span></h2><button class="modal-close" id="modal-close">√ó</button></div>
            <div class="modal-body">
                <form id="action-form">
                    <input type="hidden" id="form-id">
                    <div class="form-row">
                        <div class="form-group"><label>Axe</label><select id="form-axe"><option value="Site web">Site web</option><option value="R√©seaux sociaux">R√©seaux sociaux</option><option value="Supports papier">Supports papier</option><option value="√âv√©nementiel">√âv√©nementiel</option><option value="Presse">Presse</option><option value="Email">Email</option></select></div>
                        <div class="form-group"><label>Cat√©gorie <button type="button" id="btn-manage-categories" style="background:none;border:none;cursor:pointer;">‚öôÔ∏è</button></label><select id="form-categorie"></select></div>
                    </div>
                    <div class="form-group"><label>T√¢che</label><input type="text" id="form-tache" required></div>
                    <div class="form-group"><label>Description</label><textarea id="form-description"></textarea></div>
                    <div class="form-row">
                        <div class="form-group"><label>Responsable</label><select id="form-responsable"></select></div>
                        <div class="form-group"><label>Statut</label><select id="form-statut"><option value="√Ä faire">√Ä faire</option><option value="En cours">En cours</option><option value="Bloqu√©">Bloqu√©</option><option value="Fait">Fait</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Priorit√©</label><select id="form-priorite"><option value="Basse">Basse</option><option value="Moyenne">Moyenne</option><option value="Haute">Haute</option></select></div>
                        <div class="form-group"><label>√âch√©ance</label><input type="date" id="form-echeance"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn-action btn-delete" id="btn-delete" style="display:none"><span>üóëÔ∏è</span><span>Supprimer</span></button><div style="flex:1"></div><button class="btn-cancel" id="btn-cancel">Annuler</button><button class="btn-action btn-save" id="btn-save"><span>‚úì</span><span>Enregistrer</span></button></div>
        </div>
    </div>
    
    <div class="sync-indicator" id="sync-indicator"><span id="sync-icon">üîÑ</span><span id="sync-text">Sync...</span></div>
    
    <script>
        // EmailJS
        const EMAILJS_PUBLIC_KEY = 'mC3PZzXAloxLTMDW6';
        const EMAILJS_SERVICE_ID = 'service_7l8j34p';
        const EMAILJS_TEMPLATE_ID = 'template_mrm462e';
        emailjs.init(EMAILJS_PUBLIC_KEY);
        
        // GitHub
        const GITHUB_REPO = 'mich59139/suivi';
        const GITHUB_FILE = 'data/communication.json';
        const GITHUB_TEAM_FILE = 'data/equipe.json';
        const GITHUB_MEMBERS_FILE = 'data/membres.json';
        const GITHUB_CATEGORIES_FILE = 'data/categories.json';
        const GITHUB_BRANCH = 'main';
        
        const defaultActions = [
            { id: "COM-001", axe: "Site web", categorie: "Infrastructure", tache: "Mise en place h√©bergement", description: "Configuration serveur", responsable: "Michel", statut: "Fait", priorite: "Haute", echeance: "2025-01-15" },
            { id: "COM-002", axe: "Site web", categorie: "D√©veloppement", tache: "Page d'accueil", description: "Cr√©ation landing page", responsable: "Michel", statut: "Fait", priorite: "Haute", echeance: "2025-01-20" },
            { id: "COM-003", axe: "R√©seaux sociaux", categorie: "Contenu", tache: "Planning √©ditorial", description: "Calendrier publications", responsable: "Laurent", statut: "En cours", priorite: "Haute", echeance: "2025-02-05" },
            { id: "COM-004", axe: "Supports papier", categorie: "Cr√©ation", tache: "Tract pr√©sentation", description: "Flyer A5 avec QR code", responsable: "√âquipe", statut: "√Ä faire", priorite: "Haute", echeance: "2025-03-01" },
            { id: "COM-005", axe: "√âv√©nementiel", categorie: "Organisation", tache: "R√©unions publiques", description: "Planning r√©unions", responsable: "Catherine", statut: "√Ä faire", priorite: "Haute", echeance: "2025-03-15" }
        ];
        
        const defaultCategories = ["Infrastructure", "D√©veloppement", "Contenu", "Organisation", "Cr√©ation", "Relations", "Technique", "Administration"];
        const defaultTeam = ["Michel", "Laurent", "Catherine", "Ignazio", "√âquipe"];
        
        const defaultMembers = [
            { name: "AbdelKarim Sadgui", email: "karim_sadgui@hotmail.fr", phone: "06 98 95 85 48" },
            { name: "Ali Mendess", email: "ali.mendess38@gmail.com", phone: "06 25 19 14 58" },
            { name: "Andr√© Paul Venans", email: "andrepaul.v@gmail.com", phone: "06 10 75 51 85" },
            { name: "Angelique Hermitte", email: "angelique.hermitte@free.fr", phone: "06 27 84 39 78" },
            { name: "Axel Servant", email: "axel.servant@lettres.ucly.fr", phone: "07 83 65 07 00" },
            { name: "Bernard et Silvia Faure", email: "bernard.faure15@wanadoo.fr", phone: "06 81 46 45 19" },
            { name: "Bernard Ughetto", email: "bernard.ughettocgt@gmail.com", phone: "06 76 95 28 33" },
            { name: "Catherine Troton", email: "alain.troton@sfr.fr", phone: "06 64 11 47 07" },
            { name: "Chantal Nadi", email: "zampanette@yahoo.fr", phone: "06 62 55 58 02" },
            { name: "Christine Sanchez", email: "sanchez7.christine@gmail.com", phone: "06 32 56 55 54" },
            { name: "Evelyne Specia", email: "evelyne.specia@orange.fr", phone: "06 82 49 03 30" },
            { name: "Fabrice Pasquiou", email: "pasquiou.fab@gmail.com", phone: "06 17 08 17 84" },
            { name: "Fred Vivancos", email: "fredvivancos@gmail.com", phone: "07 82 57 20 36" },
            { name: "Georges Claveri", email: "georges.claveri@wanadoo.fr", phone: "" },
            { name: "G√©rard Forestier", email: "gerard.forestier@gmail.com", phone: "06 08 07 86 94" },
            { name: "Ignazio Cosentino", email: "ignazio.cosentino@free.fr", phone: "06 95 49 64 94" },
            { name: "Jean Christophe Garcia", email: "jeanchristophe.garcia38@gmail.com", phone: "07 68 15 07 74" },
            { name: "Jean Fran√ßois Gutierez", email: "gutierrez.jean.francois@laposte.fr", phone: "07 86 99 22 67" },
            { name: "Jean Marie Gutierrez", email: "jeanmariegutierrez@gmail.com", phone: "06 51 55 32 14" },
            { name: "Julien Pathoux", email: "julien.pathoux@gmail.com", phone: "06 62 29 34 38" },
            { name: "Katherine Merle", email: "cknds.merle@free.fr", phone: "06 32 06 73 12" },
            { name: "Lamarca Louis", email: "louislamarca@free.fr", phone: "06 24 96 41 44" },
            { name: "Laurent Pichon", email: "pichon.laurent@wanadoo.fr", phone: "06 03 59 20 17" },
            { name: "Maelle Pathoux", email: "maellepathoux38220@gmail.com", phone: "06 99 35 16 93" },
            { name: "Marie Claude Argoud", email: "marie-claude.argoud@wanadoo.fr", phone: "06 81 12 28 50" },
            { name: "Maryline Desnoulet", email: "maryline.desnoulet@outlook.fr", phone: "06 16 21 92 87" },
            { name: "Michel Thuillier", email: "thuilliermichel@mac.com", phone: "06 37 21 60 08" },
            { name: "Mohamed Cherigui", email: "mohamed.cherigui@sdis38.fr", phone: "06 51 34 36 53" },
            { name: "Muriel Pasquiou", email: "muriel.pasquiou@gmail.com", phone: "06 76 57 82 21" },
            { name: "Nicole Bresson", email: "nclbrssn@gmail.com", phone: "" },
            { name: "Roger Tournier", email: "pierogtou@free.fr", phone: "06 83 30 87 43" },
            { name: "Saida Berriche", email: "saidabvizille@gmail.com", phone: "07 80 54 43 03" },
            { name: "Sakina Yahiaoui-Servant", email: "servant.romain@wanadoo.fr", phone: "06 73 80 23 52" },
            { name: "St√©phane Lasserre", email: "scnoema@gmail.com", phone: "06 48 38 32 86" },
            { name: "Valerie Foucher", email: "vale.foucher@gmail.com", phone: "06 75 00 95 99" },
            { name: "Vincent Alessi", email: "vincent.alessi38@gmail.com", phone: "06 78 96 88 68" }
        ];
        
        let actions = JSON.parse(localStorage.getItem('vizille_actions')) || defaultActions;
        let team = JSON.parse(localStorage.getItem('vizille_team')) || defaultTeam;
        let members = JSON.parse(localStorage.getItem('vizille_members')) || defaultMembers;
        let categories = JSON.parse(localStorage.getItem('vizille_categories')) || defaultCategories;
        let filteredActions = [...actions];
        let currentView = 'cards';
        let editingId = null;
        let githubSha = null, githubTeamSha = null, githubMembersSha = null, githubCategoriesSha = null;
        let selectedRecipients = new Set();
        
        // GitHub functions
        function getGithubToken() { return localStorage.getItem('github_token') || ''; }
        function setGithubToken(token) { token ? localStorage.setItem('github_token', token) : localStorage.removeItem('github_token'); updateGithubStatus(); }
        function isGithubConnected() { return !!getGithubToken(); }
        function updateGithubStatus() { const btn = document.getElementById('btn-github'); const status = document.getElementById('github-status'); if (isGithubConnected()) { btn.classList.add('connected'); status.textContent = '‚úì GitHub'; } else { btn.classList.remove('connected'); status.textContent = 'GitHub'; } }
        function showSyncIndicator(message, type = 'info') { const indicator = document.getElementById('sync-indicator'); indicator.className = 'sync-indicator show ' + type; document.getElementById('sync-icon').textContent = type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : 'üîÑ'; document.getElementById('sync-text').textContent = message; setTimeout(() => indicator.classList.remove('show'), 3000); }
        function decodeBase64UTF8(base64) { try { const bin = atob(base64); const bytes = new Uint8Array(bin.length); for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i); return new TextDecoder('utf-8').decode(bytes); } catch (e) { return atob(base64); } }
        function encodeBase64UTF8(str) { const bytes = new TextEncoder().encode(str); let bin = ''; for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]); return btoa(bin); }
        
        async function loadFromGitHub() { const token = getGithubToken(); if (!token) return false; try { showSyncIndicator('Chargement...'); 
            let r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_FILE}`, { headers: { 'Authorization': `token ${token}` } }); if (r.ok) { const d = await r.json(); githubSha = d.sha; actions = JSON.parse(decodeBase64UTF8(d.content)); localStorage.setItem('vizille_actions', JSON.stringify(actions)); } 
            r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_TEAM_FILE}`, { headers: { 'Authorization': `token ${token}` } }); if (r.ok) { const d = await r.json(); githubTeamSha = d.sha; team = JSON.parse(decodeBase64UTF8(d.content)); localStorage.setItem('vizille_team', JSON.stringify(team)); } 
            r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_MEMBERS_FILE}`, { headers: { 'Authorization': `token ${token}` } }); if (r.ok) { const d = await r.json(); githubMembersSha = d.sha; members = JSON.parse(decodeBase64UTF8(d.content)); localStorage.setItem('vizille_members', JSON.stringify(members)); } 
            r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${GITHUB_CATEGORIES_FILE}`, { headers: { 'Authorization': `token ${token}` } }); if (r.ok) { const d = await r.json(); githubCategoriesSha = d.sha; categories = JSON.parse(decodeBase64UTF8(d.content)); localStorage.setItem('vizille_categories', JSON.stringify(categories)); } 
            showSyncIndicator('Charg√© ‚úì', 'success'); return true; } catch (e) { showSyncIndicator('Erreur', 'error'); return false; } }
        
        async function saveToGitHub(file, data, sha) { const token = getGithubToken(); if (!token) return null; try { if (!sha) { const r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${file}`, { headers: { 'Authorization': `token ${token}` } }); if (r.ok) sha = (await r.json()).sha; } const body = { message: `MAJ ${file.split('/').pop()}`, content: encodeBase64UTF8(JSON.stringify(data, null, 2)), branch: GITHUB_BRANCH }; if (sha) body.sha = sha; const response = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/contents/${file}`, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); if (response.ok) return (await response.json()).content.sha; return null; } catch (e) { return null; } }
        
        async function testGithubConnection() { const token = document.getElementById('github-token').value; const s = document.getElementById('github-connection-status'); if (!token) { s.style.display = 'block'; s.style.background = '#fee'; s.style.color = '#c00'; s.textContent = '‚ùå Token requis'; return; } s.style.display = 'block'; s.style.background = '#ffe'; s.style.color = '#860'; s.textContent = '‚è≥ Test...'; try { const r = await fetch(`https://api.github.com/repos/${GITHUB_REPO}`, { headers: { 'Authorization': `token ${token}` } }); s.style.background = r.ok ? '#efe' : '#fee'; s.style.color = r.ok ? '#080' : '#c00'; s.textContent = r.ok ? '‚úÖ OK !' : '‚ùå Erreur'; } catch (e) { s.style.background = '#fee'; s.style.color = '#c00'; s.textContent = '‚ùå ' + e.message; } }
        
        // Team
        function renderTeamList() { const list = document.getElementById('team-list'); document.getElementById('team-count').textContent = team.length; list.innerHTML = team.map((t, i) => `<li class="member-item"><div class="member-info"><div class="member-name">${t}</div></div><button class="btn-remove-member" data-index="${i}">‚úï</button></li>`).join(''); list.querySelectorAll('.btn-remove-member').forEach(btn => btn.addEventListener('click', () => removeTeamMember(parseInt(btn.dataset.index)))); }
        function addTeamMember() { const name = document.getElementById('new-team-member').value.trim(); if (!name || team.includes(name)) return; team.push(name); localStorage.setItem('vizille_team', JSON.stringify(team)); if (isGithubConnected()) saveToGitHub(GITHUB_TEAM_FILE, team, githubTeamSha).then(sha => githubTeamSha = sha); document.getElementById('new-team-member').value = ''; renderTeamList(); updateResponsableSelects(); }
        function removeTeamMember(i) { team.splice(i, 1); localStorage.setItem('vizille_team', JSON.stringify(team)); if (isGithubConnected()) saveToGitHub(GITHUB_TEAM_FILE, team, githubTeamSha).then(sha => githubTeamSha = sha); renderTeamList(); updateResponsableSelects(); }
        function updateResponsableSelects() { const opts = team.map(t => `<option value="${t}">${t}</option>`).join(''); document.getElementById('form-responsable').innerHTML = opts; document.getElementById('filter-responsable').innerHTML = '<option value="">Tous</option>' + opts; }
        
        // Members
        function renderMembersList() { const list = document.getElementById('members-list'); document.getElementById('members-count').textContent = members.length; list.innerHTML = members.map((m, i) => `<li class="member-item"><div class="member-info"><div class="member-name">${m.name}</div><div class="member-contact">${m.email ? `<a href="mailto:${m.email}">${m.email}</a>` : ''}${m.email && m.phone ? ' ‚Ä¢ ' : ''}${m.phone || ''}</div></div><button class="btn-remove-member" data-index="${i}">‚úï</button></li>`).join(''); list.querySelectorAll('.btn-remove-member').forEach(btn => btn.addEventListener('click', () => removeMember(parseInt(btn.dataset.index)))); }
        function addMember() { const name = document.getElementById('new-member-name').value.trim(); const email = document.getElementById('new-member-email').value.trim(); const phone = document.getElementById('new-member-phone').value.trim(); if (!name) return; members.push({ name, email, phone }); localStorage.setItem('vizille_members', JSON.stringify(members)); if (isGithubConnected()) saveToGitHub(GITHUB_MEMBERS_FILE, members, githubMembersSha).then(sha => githubMembersSha = sha); document.getElementById('new-member-name').value = ''; document.getElementById('new-member-email').value = ''; document.getElementById('new-member-phone').value = ''; renderMembersList(); }
        function removeMember(i) { members.splice(i, 1); localStorage.setItem('vizille_members', JSON.stringify(members)); if (isGithubConnected()) saveToGitHub(GITHUB_MEMBERS_FILE, members, githubMembersSha).then(sha => githubMembersSha = sha); renderMembersList(); }
        
        // Categories
        function renderCategoriesList() { const list = document.getElementById('categories-list'); document.getElementById('categories-count').textContent = categories.length; list.innerHTML = categories.map((c, i) => `<li class="member-item"><div class="member-info"><div class="member-name">üè∑Ô∏è ${c}</div></div><button class="btn-remove-member" data-index="${i}">‚úï</button></li>`).join(''); list.querySelectorAll('.btn-remove-member').forEach(btn => btn.addEventListener('click', () => removeCategory(parseInt(btn.dataset.index)))); }
        function addCategory() { const name = document.getElementById('new-category-name').value.trim(); if (!name || categories.includes(name)) return; categories.push(name); localStorage.setItem('vizille_categories', JSON.stringify(categories)); if (isGithubConnected()) saveToGitHub(GITHUB_CATEGORIES_FILE, categories, githubCategoriesSha).then(sha => githubCategoriesSha = sha); document.getElementById('new-category-name').value = ''; renderCategoriesList(); updateCategoriesSelect(); }
        function removeCategory(i) { categories.splice(i, 1); localStorage.setItem('vizille_categories', JSON.stringify(categories)); if (isGithubConnected()) saveToGitHub(GITHUB_CATEGORIES_FILE, categories, githubCategoriesSha).then(sha => githubCategoriesSha = sha); renderCategoriesList(); updateCategoriesSelect(); }
        function updateCategoriesSelect() { document.getElementById('form-categorie').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join(''); }
        
        // Alert with selection
        function openAlertModal() { 
            selectedRecipients.clear();
            const emailMembers = members.filter(m => m.email);
            
            // Render recipients list with checkboxes
            const list = document.getElementById('recipients-list');
            list.innerHTML = emailMembers.map((m, i) => `
                <div class="recipient-item">
                    <input type="checkbox" id="recipient-${i}" data-email="${m.email}" data-name="${m.name}">
                    <label for="recipient-${i}">
                        <strong>${m.name}</strong>
                        <span class="email">${m.email}</span>
                    </label>
                </div>
            `).join('');
            
            // Add event listeners to checkboxes
            list.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.addEventListener('change', updateSelectedCount);
            });
            
            document.getElementById('alert-subject').value = '[URGENT] Vizille en Mouvement - '; 
            document.getElementById('alert-message').value = ''; 
            document.getElementById('sending-status').className = 'sending-status';
            updateSelectedCount();
            document.getElementById('alert-modal-overlay').classList.add('active'); 
        }
        
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('#recipients-list input[type="checkbox"]:checked');
            document.getElementById('selected-count').textContent = checkboxes.length;
        }
        
        function selectAllRecipients() {
            document.querySelectorAll('#recipients-list input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateSelectedCount();
        }
        
        function deselectAllRecipients() {
            document.querySelectorAll('#recipients-list input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectedCount();
        }
        
        function getSelectedRecipients() {
            const selected = [];
            document.querySelectorAll('#recipients-list input[type="checkbox"]:checked').forEach(cb => {
                selected.push({ email: cb.dataset.email, name: cb.dataset.name });
            });
            return selected;
        }
        
        function copyForWhatsApp() {
            const subject = document.getElementById('alert-subject').value.trim();
            const message = document.getElementById('alert-message').value.trim();
            if (!message) { alert('√âcrivez un message'); return; }
            
            const selected = getSelectedRecipients();
            let whatsappText = `üö® *${subject}*\n\n${message}\n\n--\n_Vizille en Mouvement_`;
            
            if (selected.length > 0 && selected.length < members.filter(m => m.email).length) {
                whatsappText += `\n\nüìå Destinataires: ${selected.map(r => r.name).join(', ')}`;
            }
            
            navigator.clipboard.writeText(whatsappText).then(() => {
                const s = document.getElementById('sending-status');
                s.className = 'sending-status show success';
                s.textContent = '‚úÖ Copi√© ! Collez dans WhatsApp.';
            });
        }
        
        async function sendEmailAlert() {
            const subject = document.getElementById('alert-subject').value.trim();
            const message = document.getElementById('alert-message').value.trim();
            const selected = getSelectedRecipients();
            
            if (!subject || !message) { alert('Remplissez objet et message'); return; }
            if (selected.length === 0) { alert('S√©lectionnez au moins un destinataire'); return; }
            
            const s = document.getElementById('sending-status');
            s.className = 'sending-status show sending';
            s.textContent = '‚è≥ Envoi...';
            
            let sent = 0, errors = 0;
            
            for (const recipient of selected) {
                try {
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
                        to_email: recipient.email,
                        subject: subject,
                        message: message + '\n\n--\nVizille en Mouvement',
                        reply_to: 'mth144443@gmail.com'
                    });
                    sent++;
                    s.textContent = `‚è≥ ${sent}/${selected.length}...`;
                } catch (e) { errors++; console.error(e); }
            }
            
            s.className = errors === 0 ? 'sending-status show success' : 'sending-status show error';
            s.textContent = errors === 0 ? `‚úÖ ${sent} email(s) envoy√©(s) !` : `‚ö†Ô∏è ${sent} envoy√©s, ${errors} erreurs`;
        }
        
        // Data
        async function saveData() { localStorage.setItem('vizille_actions', JSON.stringify(actions)); if (isGithubConnected()) { githubSha = await saveToGitHub(GITHUB_FILE, actions, githubSha); showSyncIndicator('Sync ‚úì', 'success'); } }
        function getStatutClass(s) { return { '√Ä faire': 'afaire', 'En cours': 'encours', 'Bloqu√©': 'bloque', 'Fait': 'fait' }[s] || 'afaire'; }
        function getNextId() { const nums = actions.map(a => parseInt(a.id.replace('COM-', ''))).filter(n => !isNaN(n)); return `COM-${String((nums.length ? Math.max(...nums) : 0) + 1).padStart(3, '0')}`; }
        
        // Chart
        let statusChart = null;
        function updateChart() { const c = { afaire: actions.filter(a => a.statut === '√Ä faire').length, encours: actions.filter(a => a.statut === 'En cours').length, bloque: actions.filter(a => a.statut === 'Bloqu√©').length, fait: actions.filter(a => a.statut === 'Fait').length }; const ctx = document.getElementById('statusChart').getContext('2d'); if (statusChart) statusChart.destroy(); statusChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['√Ä faire', 'En cours', 'Bloqu√©', 'Fait'], datasets: [{ data: [c.afaire, c.encours, c.bloque, c.fait], backgroundColor: ['#3498db', '#f39c12', '#e74c3c', '#27ae60'], borderWidth: 0 }] }, options: { responsive: true, cutout: '60%', plugins: { legend: { display: false } } } }); document.getElementById('chart-legend').innerHTML = [{ l: '√Ä faire', v: c.afaire, c: '#3498db' }, { l: 'En cours', v: c.encours, c: '#f39c12' }, { l: 'Bloqu√©', v: c.bloque, c: '#e74c3c' }, { l: 'Fait', v: c.fait, c: '#27ae60' }].map(i => `<div class="legend-item" data-filter="${i.l}"><div class="legend-color" style="background:${i.c}"></div><span class="legend-label">${i.l}</span><span class="legend-value">${i.v}</span></div>`).join(''); document.querySelectorAll('.legend-item').forEach(item => item.addEventListener('click', () => { filteredActions = actions.filter(a => a.statut === item.dataset.filter); renderView(); })); }
        function updateStats() { const t = actions.length, af = actions.filter(a => a.statut === '√Ä faire').length, ec = actions.filter(a => a.statut === 'En cours').length, bl = actions.filter(a => a.statut === 'Bloqu√©').length, fa = actions.filter(a => a.statut === 'Fait').length, ha = actions.filter(a => a.priorite === 'Haute').length; document.getElementById('stats-bar').innerHTML = `<div class="stat-chip" data-filter="all"><span class="stat-number">${t}</span><span>Total</span></div><div class="stat-chip afaire" data-filter="√Ä faire"><span class="stat-number">${af}</span><span>√Ä faire</span></div><div class="stat-chip encours" data-filter="En cours"><span class="stat-number">${ec}</span><span>En cours</span></div><div class="stat-chip bloque" data-filter="Bloqu√©"><span class="stat-number">${bl}</span><span>Bloqu√©</span></div><div class="stat-chip fait" data-filter="Fait"><span class="stat-number">${fa}</span><span>Fait</span></div><div class="stat-chip haute" data-filter="Haute"><span class="stat-number">${ha}</span><span>Haute</span></div>`; document.querySelectorAll('.stat-chip').forEach(chip => chip.addEventListener('click', () => { const f = chip.dataset.filter; document.querySelectorAll('.stat-chip').forEach(c => c.classList.remove('active')); filteredActions = f === 'all' ? [...actions] : f === 'Haute' ? actions.filter(a => a.priorite === 'Haute') : actions.filter(a => a.statut === f); if (f !== 'all') chip.classList.add('active'); renderView(); })); }
        
        // Filters & render
        function populateFilters() { updateResponsableSelects(); updateCategoriesSelect(); document.getElementById('filter-axe').innerHTML = '<option value="">Tous axes</option>' + [...new Set(actions.map(a => a.axe))].sort().map(a => `<option value="${a}">${a}</option>`).join(''); }
        function applyFilters() { const s = document.getElementById('search-input').value.toLowerCase(), r = document.getElementById('filter-responsable').value, x = document.getElementById('filter-axe').value; filteredActions = actions.filter(a => (!s || a.tache.toLowerCase().includes(s) || a.id.toLowerCase().includes(s)) && (!r || a.responsable === r) && (!x || a.axe === x)); document.querySelectorAll('.stat-chip').forEach(c => c.classList.remove('active')); renderView(); }
        function renderView() { currentView === 'cards' ? (renderCards(), document.getElementById('cards-container').style.display = 'grid', document.getElementById('table-container').classList.remove('active')) : (renderTable(), document.getElementById('cards-container').style.display = 'none', document.getElementById('table-container').classList.add('active')); }
        function renderCards() { const c = document.getElementById('cards-container'); if (!filteredActions.length) { c.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">üì≠</div><h3>Aucune action</h3></div>'; return; } c.innerHTML = filteredActions.map(a => `<div class="action-card" data-id="${a.id}"><div class="card-header"><span class="card-id">${a.id}</span><div class="card-badges"><span class="badge badge-statut ${getStatutClass(a.statut)}">${a.statut}</span>${a.priorite === 'Haute' ? '<span class="badge badge-priorite">‚ö°</span>' : ''}</div></div><div class="card-body"><div class="card-title">${a.tache}</div><div class="card-description">${a.description || ''}</div></div><div class="card-footer"><div class="card-meta"><span>üë§</span><span>${a.responsable}</span></div><span class="card-axe">${a.axe}</span></div></div>`).join(''); c.querySelectorAll('.action-card').forEach(card => card.addEventListener('click', () => openModal(card.dataset.id))); }
        function renderTable() { const b = document.getElementById('table-body'); if (!filteredActions.length) { b.innerHTML = '<tr><td colspan="6">Aucune</td></tr>'; return; } b.innerHTML = filteredActions.map(a => `<tr data-id="${a.id}"><td><span class="card-id">${a.id}</span></td><td>${a.tache}</td><td>${a.responsable}</td><td><span class="badge badge-statut ${getStatutClass(a.statut)}">${a.statut}</span></td><td>${a.priorite}</td><td>${a.axe}</td></tr>`).join(''); b.querySelectorAll('tr').forEach(row => row.addEventListener('click', () => openModal(row.dataset.id))); }
        
        // Modal
        function openModal(id = null) { editingId = id; updateResponsableSelects(); updateCategoriesSelect(); if (id) { const a = actions.find(x => x.id === id); if (!a) return; document.getElementById('modal-icon').textContent = 'üìù'; document.getElementById('modal-title').textContent = a.id; document.getElementById('form-id').value = a.id; document.getElementById('form-axe').value = a.axe; document.getElementById('form-categorie').value = a.categorie || categories[0]; document.getElementById('form-tache').value = a.tache; document.getElementById('form-description').value = a.description || ''; document.getElementById('form-responsable').value = a.responsable; document.getElementById('form-statut').value = a.statut; document.getElementById('form-priorite').value = a.priorite; document.getElementById('form-echeance').value = a.echeance || ''; document.getElementById('btn-delete').style.display = 'flex'; } else { document.getElementById('modal-icon').textContent = '‚ûï'; document.getElementById('modal-title').textContent = 'Nouvelle'; document.getElementById('form-id').value = getNextId(); document.getElementById('form-axe').value = 'Site web'; document.getElementById('form-categorie').value = categories[0]; document.getElementById('form-tache').value = ''; document.getElementById('form-description').value = ''; document.getElementById('form-responsable').value = team[0] || ''; document.getElementById('form-statut').value = '√Ä faire'; document.getElementById('form-priorite').value = 'Moyenne'; document.getElementById('form-echeance').value = ''; document.getElementById('btn-delete').style.display = 'none'; } document.getElementById('modal-overlay').classList.add('active'); }
        function closeModal() { document.getElementById('modal-overlay').classList.remove('active'); editingId = null; }
        function saveAction() { const d = { id: document.getElementById('form-id').value, axe: document.getElementById('form-axe').value, categorie: document.getElementById('form-categorie').value, tache: document.getElementById('form-tache').value, description: document.getElementById('form-description').value, responsable: document.getElementById('form-responsable').value, statut: document.getElementById('form-statut').value, priorite: document.getElementById('form-priorite').value, echeance: document.getElementById('form-echeance').value }; if (!d.tache.trim()) return; if (editingId) { const i = actions.findIndex(a => a.id === editingId); if (i !== -1) actions[i] = d; } else actions.push(d); saveData(); populateFilters(); updateStats(); updateChart(); applyFilters(); closeModal(); }
        function deleteAction() { if (!editingId || !confirm('Supprimer ?')) return; actions = actions.filter(a => a.id !== editingId); saveData(); populateFilters(); updateStats(); updateChart(); applyFilters(); closeModal(); }
        
        // Export/Import
        function exportData() { const BOM = '\uFEFF'; const h = ['ID', 'Axe', 'Cat√©gorie', 'T√¢che', 'Description', 'Responsable', 'Statut', 'Priorit√©', '√âch√©ance']; const csv = BOM + h.join(';') + '\n' + actions.map(a => [a.id, a.axe, a.categorie || '', a.tache, (a.description || '').replace(/[\n\r;]/g, ' '), a.responsable, a.statut, a.priorite, a.echeance || ''].map(v => `"${(v || '').replace(/"/g, '""')}"`).join(';')).join('\n'); const el = document.createElement('a'); el.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); el.download = `suivi-${new Date().toISOString().split('T')[0]}.csv`; el.click(); }
        function importData(e) { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ev => { try { let d; if (f.name.endsWith('.csv')) { const lines = ev.target.result.split('\n').filter(l => l.trim()); d = lines.slice(1).map(line => { const v = line.split(';').map(x => x.replace(/^"|"$/g, '').trim()); return { id: v[0], axe: v[1], categorie: v[2], tache: v[3], description: v[4], responsable: v[5], statut: v[6], priorite: v[7], echeance: v[8] }; }).filter(x => x.id); } else d = JSON.parse(ev.target.result); if (Array.isArray(d) && confirm(`Importer ${d.length} actions ?`)) { actions = d; saveData(); populateFilters(); updateStats(); updateChart(); applyFilters(); } } catch(err) { alert('Erreur'); } }; r.readAsText(f, 'UTF-8'); e.target.value = ''; }
        
        function closeAllModals() { ['modal-overlay', 'team-modal-overlay', 'group-modal-overlay', 'categories-modal-overlay', 'alert-modal-overlay', 'github-modal-overlay'].forEach(id => document.getElementById(id).classList.remove('active')); }
        
        // Init
        async function init() {
            updateGithubStatus();
            if (isGithubConnected()) { await loadFromGitHub(); filteredActions = [...actions]; }
            populateFilters(); updateStats(); updateChart(); renderView();
            
            document.getElementById('search-input').addEventListener('input', applyFilters);
            document.getElementById('filter-responsable').addEventListener('change', applyFilters);
            document.getElementById('filter-axe').addEventListener('change', applyFilters);
            document.querySelectorAll('.view-btn').forEach(b => b.addEventListener('click', () => { document.querySelectorAll('.view-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); currentView = b.dataset.view; renderView(); }));
            document.getElementById('btn-new').addEventListener('click', () => openModal());
            document.getElementById('btn-export').addEventListener('click', exportData);
            document.getElementById('btn-import').addEventListener('click', () => document.getElementById('import-file').click());
            document.getElementById('import-file').addEventListener('change', importData);
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('btn-cancel').addEventListener('click', closeModal);
            document.getElementById('btn-save').addEventListener('click', saveAction);
            document.getElementById('btn-delete').addEventListener('click', deleteAction);
            document.getElementById('modal-overlay').addEventListener('click', e => { if (e.target.id === 'modal-overlay') closeModal(); });
            
            document.getElementById('btn-team').addEventListener('click', () => { renderTeamList(); document.getElementById('team-modal-overlay').classList.add('active'); });
            document.getElementById('team-modal-close').addEventListener('click', () => document.getElementById('team-modal-overlay').classList.remove('active'));
            document.getElementById('team-modal-done').addEventListener('click', () => document.getElementById('team-modal-overlay').classList.remove('active'));
            document.getElementById('btn-add-team-member').addEventListener('click', addTeamMember);
            document.getElementById('new-team-member').addEventListener('keypress', e => { if (e.key === 'Enter') addTeamMember(); });
            
            document.getElementById('btn-group').addEventListener('click', () => { renderMembersList(); document.getElementById('group-modal-overlay').classList.add('active'); });
            document.getElementById('group-modal-close').addEventListener('click', () => document.getElementById('group-modal-overlay').classList.remove('active'));
            document.getElementById('group-modal-done').addEventListener('click', () => document.getElementById('group-modal-overlay').classList.remove('active'));
            document.getElementById('btn-add-member').addEventListener('click', addMember);
            
            document.getElementById('btn-manage-categories').addEventListener('click', () => { renderCategoriesList(); document.getElementById('categories-modal-overlay').classList.add('active'); });
            document.getElementById('categories-modal-close').addEventListener('click', () => document.getElementById('categories-modal-overlay').classList.remove('active'));
            document.getElementById('categories-modal-done').addEventListener('click', () => document.getElementById('categories-modal-overlay').classList.remove('active'));
            document.getElementById('btn-add-category').addEventListener('click', addCategory);
            
            document.getElementById('btn-alert').addEventListener('click', openAlertModal);
            document.getElementById('alert-modal-close').addEventListener('click', () => document.getElementById('alert-modal-overlay').classList.remove('active'));
            document.getElementById('alert-modal-cancel').addEventListener('click', () => document.getElementById('alert-modal-overlay').classList.remove('active'));
            document.getElementById('btn-select-all').addEventListener('click', selectAllRecipients);
            document.getElementById('btn-deselect-all').addEventListener('click', deselectAllRecipients);
            document.getElementById('btn-copy-whatsapp').addEventListener('click', copyForWhatsApp);
            document.getElementById('btn-send-email').addEventListener('click', sendEmailAlert);
            
            document.getElementById('btn-github').addEventListener('click', () => { document.getElementById('github-token').value = getGithubToken(); document.getElementById('github-connection-status').style.display = 'none'; document.getElementById('github-modal-overlay').classList.add('active'); });
            document.getElementById('github-modal-close').addEventListener('click', () => document.getElementById('github-modal-overlay').classList.remove('active'));
            document.getElementById('github-test').addEventListener('click', testGithubConnection);
            document.getElementById('github-save-config').addEventListener('click', async () => { setGithubToken(document.getElementById('github-token').value); document.getElementById('github-modal-overlay').classList.remove('active'); await loadFromGitHub(); filteredActions = [...actions]; populateFilters(); updateStats(); updateChart(); renderView(); });
            document.getElementById('github-disconnect').addEventListener('click', () => { setGithubToken(''); document.getElementById('github-token').value = ''; });
            
            document.addEventListener('keydown', e => { if (e.key === 'Escape') closeAllModals(); });
        }
        
        init();
    </script>
</body>
</html>
